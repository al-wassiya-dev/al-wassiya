<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Wassiya - Votre Testament Islamique Simplifié</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #C9B178;
            --primary-dark: #A89262;
            --secondary: #2D4C68;
            --accent: #3A5F7E;
            --light: #F8F5EE;
            --dark: #1E1E24;
            --success: #4CAF50;
            --error: #E74C3C;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #F8F5EE 0%, #E6E2D6 100%);
            color: var(--dark);
            line-height: 1.7;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            text-align: center;
            padding: 40px 0;
            margin-bottom: 30px;
            position: relative;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .arabic-subtitle {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--secondary);
            margin-bottom: 25px;
            font-weight: 400;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .bismillah {
            font-size: 2.2rem;
            color: var(--primary);
            margin: 25px 0;
            font-weight: 600;
        }

        /* Progress Section */
        .progress-container {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .progress-bar {
            height: 8px;
            background: #EDE8DD;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 15%;
            border-radius: 4px;
            transition: var(--transition);
        }

        .step-indicator {
            font-size: 1.1rem;
            color: var(--secondary);
            font-weight: 500;
        }

        /* Quranic Verse */
        .quranic-verse {
            background: linear-gradient(135deg, rgba(201, 177, 120, 0.1) 0%, rgba(168, 146, 98, 0.1) 100%);
            border-left: 4px solid var(--primary);
            padding: 25px;
            margin: 30px 0;
            border-radius: 0 var(--radius) var(--radius) 0;
            font-style: italic;
            color: var(--secondary);
            font-size: 1.1rem;
            line-height: 1.8;
            text-align: center;
        }

        .arabic-verse {
            font-size: 1.6rem;
            margin-bottom: 20px;
            line-height: 2;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .translation-note {
            font-size: 0.9rem;
            color: var(--primary-dark);
            margin-top: 10px;
            font-style: italic;
        }

        /* Form Styles */
        .form-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 992px) {
            .form-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .form-section {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .form-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.6rem;
            color: var(--secondary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(201, 177, 120, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title i {
            color: var(--primary);
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--secondary);
            font-weight: 500;
            font-size: 1.05rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 16px;
            border: 2px solid #EDE8DD;
            border-radius: 10px;
            background: #FCFAF7;
            color: var(--dark);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(201, 177, 120, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 130px;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #A0A0A0;
        }

        .form-group select option {
            padding: 12px;
        }

        .required {
            color: var(--error);
        }

        /* Family Section Styles */
        .family-category {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: var(--radius);
            background: #F8F5EE;
            border: 1px solid rgba(201, 177, 120, 0.2);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .category-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-content {
            display: none;
            padding-top: 15px;
        }

        .category-content.active {
            display: block;
        }

        .person-entry {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
        }

        .add-person-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .add-person-btn:hover {
            background: var(--primary-dark);
        }

        .remove-person-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* Asset Section Styles */
        .asset-category {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: var(--radius);
            background: #F8F5EE;
            border: 1px solid rgba(201, 177, 120, 0.2);
        }

        .asset-entry {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
        }

        /* Buttons */
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 40px 0;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(168, 146, 98, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        /* Share Buttons */
        .share-section {
            text-align: center;
            margin: 30px 0;
            background: white;
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .share-title {
            font-size: 1.2rem;
            color: var(--secondary);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .share-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            color: white;
            font-size: 1.3rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .share-btn:hover {
            transform: translateY(-3px) scale(1.05);
        }

        .whatsapp { background: #25D366; }
        .facebook { background: #3b5998; }
        .twitter { background: #1DA1F2; }
        .email { background: #d44638; }

        /* Footer */
        .footer-note {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            margin-top: 50px;
            box-shadow: var(--shadow);
        }

        .footer-note p {
            margin-bottom: 15px;
            color: var(--secondary);
        }

        .footer-note p:last-child {
            margin-bottom: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .logo {
                font-size: 2.8rem;
            }
            
            .bismillah {
                font-size: 1.8rem;
            }
            
            .arabic-verse {
                font-size: 1.4rem;
            }
            
            .form-section {
                padding: 25px 20px;
            }
            
            .section-title {
                font-size: 1.4rem;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .share-buttons {
                gap: 10px;
            }
            
            .share-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section {
            animation: fadeIn 0.6s ease-out;
        }

        /* Islamic Pattern Background */
        .islamic-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(201, 177, 120, 0.03) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(168, 146, 98, 0.03) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
        }

        /* Step Navigation */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .privacy-notice {
            background-color: #f8f5ee;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 var(--radius) var(--radius) 0;
            font-size: 0.9rem;
            color: var(--secondary);
        }
        
        .zakat-calculator {
            background-color: white;
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .calculator-result {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--light);
            border-radius: var(--radius);
            font-weight: 500;
            color: var(--secondary);
            display: none;
        }

        /* Améliorations ajoutées */
        .step-dots {
            display: flex;
            justify-content: center;
            margin: 20px 0 40px;
            gap: 12px;
        }

        .step-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #EDE8DD;
            cursor: pointer;
            transition: var(--transition);
        }

        .step-dot.active {
            background-color: var(--primary);
            transform: scale(1.2);
        }

        .step-dot.completed {
            background-color: var(--success);
        }

        .validation-error {
            color: var(--error);
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }

        input:invalid, textarea:invalid, select:invalid {
            border-color: var(--error);
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--success);
            color: white;
            padding: 10px 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .save-indicator.visible {
            opacity: 1;
        }

        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 10px;
            background: var(--primary);
            color: white;
            padding: 8px;
            border-radius: 4px;
            z-index: 100;
            transition: top 0.3s ease;
        }

        .skip-to-content:focus {
            top: 10px;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Nouveaux styles pour la section héritage */
        .heritage-section {
            background-color: #f8f9fa;
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(201, 177, 120, 0.3);
        }
        
        .heritage-title {
            font-family: 'Playfair Display', serif;
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .heritage-note {
            background-color: rgba(201, 177, 120, 0.1);
            padding: 15px;
            border-radius: var(--radius);
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        .heritage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .heritage-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .heritage-item-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .heritage-share {
            font-size: 0.9rem;
            color: var(--primary-dark);
            font-weight: 500;
        }
        
        .legs-container {
            margin-top: 20px;
        }
        
        .leg-entry {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
            position: relative;
        }
        
        .leg-amount {
            font-weight: 600;
            color: var(--primary-dark);
            margin-top: 10px;
        }
        
        .total-assets {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .total-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-top: 10px;
        }
        
        .legs-summary {
            background: rgba(201, 177, 120, 0.1);
            padding: 15px;
            border-radius: var(--radius);
            margin: 15px 0;
        }
        
        .warning {
            color: var(--error);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-content">Aller au contenu principal</a>
    
    <div class="islamic-pattern"></div>
    
    <div class="container">
        <div class="header">
            <div class="logo">Al Wassiya</div>
            <div class="arabic-subtitle">الوصية</div>
            <div class="subtitle">Votre Testament Islamique Simplifié</div>
            <div class="bismillah">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيم</div>
            <p>Créez facilement un testament islamique respectant le Coran et la Sunna</p>
        </div>

        <div class="step-dots" id="stepDots">
            <div class="step-dot active" data-step="1"></div>
            <div class="step-dot" data-step="2"></div>
            <div class="step-dot" data-step="3"></div>
            <div class="step-dot" data-step="4"></div>
            <div class="step-dot" data-step="5"></div>
            <div class="step-dot" data-step="6"></div>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="step-indicator" id="stepIndicator">
                Étape 1 sur 6 : Informations personnelles et volontés générales
            </div>
        </div>

        <div class="quranic-verse">
            <div class="arabic-verse">كُتِبَ عَلَيْكُمْ إِذَا حَضَرَ أَحَدَكُمُ الْمَوْتُ إِن تَرَكَ خَيْرًا الْوَصِيَّةُ لِلْوَالِدَيْنِ وَالْأَقْرَبِينَ بِالْمَعْرُوفِ ۖ حَقًّا عَلَى الْمُتَّقِينَ</div>
            <div>"Il vous est prescrit, quand la mort se présente à l'un de vous, s'il laisse des biens, de faire un testament en faveur de ses père et mère et de ses proches, selon les convenances. C'est un devoir pour les pieux." - Sourate Al-Baqara, verset 180</div>
            <div class="translation-note">(c'est une traduction rapprochée)</div>
        </div>

        <main id="main-content">
            <!-- Étape 1: Informations personnelles -->
            <form id="testamentForm" novalidate>
                <div id="step1" class="form-step">
                    <div class="form-container">
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-user"></i> Identité du défunt</h2>
                            
                            <div class="form-group">
                                <label for="sexe">Sexe <span class="required">*</span></label>
                                <select id="sexe" name="sexe" required onchange="toggleConjointField()">
                                    <option value="">Sélectionner</option>
                                    <option value="homme">Homme</option>
                                    <option value="femme">Femme</option>
                                </select>
                                <div class="validation-error" id="sexe-error">Veuillez sélectionner votre sexe</div>
                            </div>

                            <div class="form-group">
                                <label for="prenom">Prénom <span class="required">*</span></label>
                                <input type="text" id="prenom" name="prenom" required placeholder="Votre prénom">
                                <div class="validation-error" id="prenom-error">Veuillez saisir votre prénom</div>
                            </div>

                            <div class="form-group">
                                <label for="nom">Nom de famille <span class="required">*</span></label>
                                <input type="text" id="nom" name="nom" required placeholder="Votre nom de famille">
                                <div class="validation-error" id="nom-error">Veuillez saisir votre nom</div>
                            </div>

                            <div class="form-group">
                                <label for="dateNaissance">Date de naissance <span class="required">*</span></label>
                                <input type="date" id="dateNaissance" name="dateNaissance" required>
                                <div class="validation-error" id="dateNaissance-error">Veuillez saisir votre date de naissance</div>
                            </div>

                            <div class="form-group">
                                <label for="lieuNaissance">Lieu de naissance</label>
                                <input type="text" id="lieuNaissance" name="lieuNaissance" placeholder="Ville et pays de naissance">
                            </div>

                            <div class="form-group">
                                <label for="adresse">Adresse actuelle <span class="required">*</span></label>
                                <textarea id="adresse" name="adresse" required placeholder="Votre adresse complète"></textarea>
                                <div class="validation-error" id="adresse-error">Veuillez saisir votre adresse</div>
                            </div>

                            <div class="form-group">
                                <label for="nationalite">Nationalité</label>
                                <input type="text" id="nationalite" name="nationalite" placeholder="Votre nationalité">
                            </div>

                            <div class="form-group">
                                <label for="situationFamiliale">Situation familiale</label>
                                <select id="situationFamiliale" name="situationFamiliale" onchange="toggleConjointField()">
                                    <option value="">Sélectionner</option>
                                    <option value="celibataire">Célibataire</option>
                                    <option value="marie">Marié(e)</option>
                                    <option value="divorce">Divorcé(e)</option>
                                    <option value="veuf">Veuf/Veuve</option>
                                </select>
                            </div>

                            <div class="form-group" id="conjointGroup" style="display: none;">
                                <label for="conjoint" id="conjointLabel">Identité de l'époux/épouse</label>
                                <input type="text" id="conjoint" name="conjoint" placeholder="Nom et prénom du conjoint">
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-scroll"></i> Volontés générales</h2>
                            
                            <div class="form-group">
                                <label for="volontesObseques">Volontés concernant les obsèques</label>
                                <textarea id="volontesObseques" name="volontesObseques" placeholder="Indiquez vos souhaits concernant l'inhumation, la mosquée pour la prière, le lieu de sépulture, etc."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="recommandationsFamille">Recommandations à la famille</label>
                                <textarea id="recommandationsFamille" name="recommandationsFamille" placeholder="Messages, conseils ou recommandations pour votre famille"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="executeurTestament">Exécuteur testamentaire suggéré</label>
                                <input type="text" id="executeurTestament" name="executeurTestament" placeholder="Nom de la personne de confiance">
                            </div>

                            <div class="form-group">
                                <label for="contactExecuteur">Contact de l'exécuteur</label>
                                <input type="text" id="contactExecuteur" name="contactExecuteur" placeholder="Téléphone ou email">
                            </div>

                            <div class="form-group">
                                <label for="autresVolontes">Autres volontés ou instructions</label>
                                <textarea id="autresVolontes" name="autresVolontes" placeholder="Toute autre instruction importante"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Étape 2: Famille et proches -->
                <div id="step2" class="form-step" style="display: none;">
                    <div class="form-container">
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-users"></i> Famille et proches</h2>
                            
                            <div class="family-category">
                                <div class="category-header" onclick="toggleCategory('parents')">
                                    <div class="category-title">
                                        <i class="fas fa-user-friends"></i> Parents
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="parents" class="category-content">
                                    <div class="form-group">
                                        <label for="pere">Père</label>
                                        <select id="pere" name="pere">
                                            <option value="">Sélectionner le statut du père</option>
                                            <option value="vivant">Père vivant</option>
                                            <option value="decede">Père décédé</option>
                                            <option value="inconnu">Statut inconnu</option>
                                        </select>
                                    </div>
                                    <div class="form-group" id="pereDetails" style="display: none;">
                                        <label for="prenomPere">Prénom et nom du père</label>
                                        <input type="text" id="prenomPere" name="prenomPere" placeholder="Prénom et nom complet du père">
                                        <label for="contactPere">Contact du père</label>
                                        <input type="text" id="contactPere" name="contactPere" placeholder="Téléphone ou email">
                                        <label for="adressePere">Adresse du père</label>
                                        <textarea id="adressePere" name="adressePere" placeholder="Adresse complète du père"></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="mere">Mère</label>
                                        <select id="mere" name="mere">
                                            <option value="">Sélectionner le statut de la mère</option>
                                            <option value="vivante">Mère vivante</option>
                                            <option value="decedee">Mère décédée</option>
                                            <option value="inconnu">Statut inconnu</option>
                                        </select>
                                    </div>
                                    <div class="form-group" id="mereDetails" style="display: none;">
                                        <label for="prenomMere">Prénom et nom de la mère</label>
                                        <input type="text" id="prenomMere" name="prenomMere" placeholder="Prénom et nom complet de la mère">
                                        <label for="contactMere">Contact de la mère</label>
                                        <input type="text" id="contactMere" name="contactMere" placeholder="Téléphone ou email">
                                        <label for="adresseMere">Adresse de la mère</label>
                                        <textarea id="adresseMere" name="adresseMere" placeholder="Adresse complète de la mère"></textarea>
                                    </div>
                                    
                                    <div id="parents-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addPerson('parents')">
                                        <i class="fas fa-plus"></i> Ajouter un autre parent
                                    </button>
                                </div>
                            </div>

                            <div class="family-category">
                                <div class="category-header" onclick="toggleCategory('conjoints')">
                                    <div class="category-title">
                                        <i class="fas fa-ring"></i> Époux/Épouse
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="conjoints" class="category-content">
                                    <div id="conjoints-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addPerson('conjoints')">
                                        <i class="fas fa-plus"></i> Ajouter un conjoint
                                    </button>
                                </div>
                            </div>

                            <div class="family-category">
                                <div class="category-header" onclick="toggleCategory('freres-soeurs')">
                                    <div class="category-title">
                                        <i class="fas fa-users"></i> Frères et Soeurs
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="freres-soeurs" class="category-content">
                                    <div class="form-group">
                                        <label for="nombreFreres">Nombre de frères</label>
                                        <select id="nombreFreres" name="nombreFreres" onchange="generateSiblings('freres')">
                                            <option value="">Sélectionner</option>
                                            <option value="0">Aucun frère</option>
                                            <option value="1">1 frère</option>
                                            <option value="2">2 frères</option>
                                            <option value="3">3 frères</option>
                                            <option value="4">4 frères</option>
                                            <option value="5">5 frères ou plus</option>
                                        </select>
                                    </div>
                                    <div id="freresDetails"></div>
                                    
                                    <div class="form-group">
                                        <label for="nombreSoeurs">Nombre de soeurs</label>
                                        <select id="nombreSoeurs" name="nombreSoeurs" onchange="generateSiblings('soeurs')">
                                            <option value="">Sélectionner</option>
                                            <option value="0">Aucune soeur</option>
                                            <option value="1">1 soeur</option>
                                            <option value="2">2 soeurs</option>
                                            <option value="3">3 soeurs</option>
                                            <option value="4">4 soeurs</option>
                                            <option value="5">5 soeurs ou plus</option>
                                        </select>
                                    </div>
                                    <div id="soeursDetails"></div>
                                    
                                    <div id="freres-soeurs-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addPerson('freres-soeurs')">
                                        <i class="fas fa-plus"></i> Ajouter un frère/une soeur
                                    </button>
                                </div>
                            </div>

                            <div class="family-category">
                                <div class="category-header" onclick="toggleCategory('enfants')">
                                    <div class="category-title">
                                        <i class="fas fa-baby"></i> Enfants
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="enfants" class="category-content">
                                    <div class="form-group">
                                        <label for="nombreEnfants">Nombre d'enfants</label>
                                        <select id="nombreEnfants" name="nombreEnfants" onchange="generateChildren()">
                                            <option value="">Sélectionner</option>
                                            <option value="0">Aucun enfant</option>
                                            <option value="1">1 enfant</option>
                                            <option value="2">2 enfants</option>
                                            <option value="3">3 enfants</option>
                                            <option value="4">4 enfants</option>
                                            <option value="5">5 enfants</option>
                                            <option value="6">6 enfants ou plus</option>
                                        </select>
                                    </div>
                                    <div id="enfantsDetails"></div>
                                    
                                    <div id="enfants-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addPerson('enfants')">
                                        <i class="fas fa-plus"></i> Ajouter un enfant
                                    </button>
                                </div>
                            </div>

                            <div class="family-category">
                                <div class="category-header" onclick="toggleCategory('amis')">
                                    <div class="category-title">
                                        <i class="fas fa-heart"></i> Amis proches
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="amis" class="category-content">
                                    <div id="amis-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addPerson('amis')">
                                        <i class="fas fa-plus"></i> Ajouter un ami
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-info-circle"></i> Informations complémentaires</h2>
                            
                            <div class="form-group">
                                <label for="autresProches">Autres personnes à mentionner</label>
                                <textarea id="autresProches" name="autresProches" placeholder="Toute autre personne que vous souhaitez mentionner dans votre testament"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="relationsParticulieres">Relations particulières</label>
                                <textarea id="relationsParticulieres" name="relationsParticulieres" placeholder="Décrivez toute relation particulière ou situation familiale importante"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="personnesPrevenir">Personnes à prévenir en priorité</label>
                                <textarea id="personnesPrevenir" name="personnesPrevenir" placeholder="Liste des personnes à contacter en priorité en cas de décès"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Étape 3: Biens matériels et financiers -->
                <div id="step3" class="form-step" style="display: none;">
                    <div class="form-container">
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-home"></i> Biens immobiliers</h2>
                            
                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('immobilier')">
                                    <div class="category-title">
                                        <i class="fas fa-building"></i> Propriétés immobilières
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="immobilier" class="category-content">
                                    <div id="immobilier-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addAsset('immobilier')">
                                        <i class="fas fa-plus"></i> Ajouter un bien immobilier
                                    </button>
                                </div>
                            </div>

                            <div class="privacy-notice">
                                <i class="fas fa-shield-alt"></i> Les informations personnelles que vous saisissez sont sous votre responsabilité. Nous recommandons de ne pas inclure de données trop sensibles.
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-car"></i> Biens matériels</h2>
                            
                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('materiel')">
                                    <div class="category-title">
                                        <i class="fas fa-tshirt"></i> Biens de valeur
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="materiel" class="category-content">
                                    <div id="materiel-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addAsset('materiel')">
                                        <i class="fas fa-plus"></i> Ajouter un bien matériel
                                    </button>
                                </div>
                            </div>

                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('personnels')">
                                    <div class="category-title">
                                        <i class="fas fa-book"></i> Biens personnels
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="personnels" class="category-content">
                                    <div id="personnels-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addAsset('personnels')">
                                        <i class="fas fa-plus"></i> Ajouter un bien personnel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-university"></i> Comptes bancaires</h2>
                            
                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('comptes')">
                                    <div class="category-title">
                                        <i class="fas fa-piggy-bank"></i> Comptes et épargnes
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="comptes" class="category-content">
                                    <div id="comptes-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addAsset('comptes')">
                                        <i class="fas fa-plus"></i> Ajouter un compte
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-credit-card"></i> Cartes et accès bancaires</h2>
                            
                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('cartes')">
                                    <div class="category-title">
                                        <i class="fas fa-credit-card"></i> Cartes bancaires
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="cartes" class="category-content">
                                    <div id="cartes-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addAsset('cartes')">
                                        <i class="fas fa-plus"></i> Ajouter une carte
                                    </button>
                                </div>
                            </div>

                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('applications')">
                                    <div class="category-title">
                                        <i class="fas fa-mobile-alt"></i> Applications bancaires
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="applications" class="category-content">
                                    <div id="applications-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addAsset('applications')">
                                        <i class="fas fa-plus"></i> Ajouter une application
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="zakat-calculator">
                        <h3 class="section-title">
                            <i class="fas fa-calculator"></i> Calculateur de Zakat
                        </h3>
                        <div class="form-group">
                            <label for="nissab">Nisâb (seuil d'imposition) en euros</label>
                            <input type="number" id="nissab" name="nissab" value="4265" placeholder="4265" oninput="calculateZakat()">
                            <small>Le Nisâb actuel est d'environ 4265€ (85g d'or). Vous pouvez l'ajuster selon la valeur actuelle de l'or.</small>
                        </div>
                        <div class="form-group">
                            <label for="montantZakat">Total de vos biens imposables (en €)</label>
                            <input type="number" id="montantZakat" name="montantZakat" placeholder="Montant en euros" oninput="calculateZakat()">
                        </div>
                        <div class="calculator-result" id="zakatResult"></div>
                    </div>
                </div>

                <!-- Étape 4: Dettes et obligations -->
                <div id="step4" class="form-step" style="display: none;">
                    <div class="form-container">
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-balance-scale"></i> Dettes et créances</h2>
                            
                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('dettes')">
                                    <div class="category-title">
                                        <i class="fas fa-minus-circle"></i> Dettes à payer
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="dettes" class="category-content">
                                    <div id="dettes-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addDebt('dettes')">
                                        <i class="fas fa-plus"></i> Ajouter une dette
                                    </button>
                                </div>
                            </div>

                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('creances')">
                                    <div class="category-title">
                                        <i class="fas fa-plus-circle"></i> Créances à récupérer
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="creances" class="category-content">
                                    <div id="creances-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addDebt('creances')">
                                        <i class="fas fa-plus"></i> Ajouter une créance
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-mosque"></i> Obligations religieuses</h2>
                            
                            <div class="form-group">
                                <label for="zakatDue">Zakat non versée</label>
                                <textarea id="zakatDue" name="zakatDue" placeholder="Montant et détails de la Zakat non versée"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="hadjStatus">Statut du Hajj</label>
                                <select id="hadjStatus" name="hadjStatus">
                                    <option value="">Sélectionner</option>
                                    <option value="accompli">Hajj accompli</option>
                                    <option value="non-accompli">Hajj non accompli mais obligatoire</option>
                                    <option value="non-obligatoire">Hajj non obligatoire</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="jeuneManque">Jours de jeûne à rattraper</label>
                                <input type="number" id="jeuneManque" name="jeuneManque" placeholder="Nombre de jours">
                            </div>

                            <div class="form-group">
                                <label for="priereManque">Prières manquées</label>
                                <textarea id="priereManque" name="priereManque" placeholder="Détails des prières à rattraper si applicable"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="sadaqa">Sadaqa et aumônes prévues</label>
                                <textarea id="sadaqa" name="sadaqa" placeholder="Montants et bénéficiaires des aumônes que vous souhaitez donner"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Étape 5: Héritage et répartition -->
                <div id="step5" class="form-step" style="display: none;">
                    <div class="heritage-section">
                        <h2 class="heritage-title">
                            <i class="fas fa-balance-scale"></i> Répartition de l'héritage selon le Coran
                        </h2>
                        
                        <div class="heritage-note">
                            <strong>Note importante :</strong> Selon la loi islamique, la répartition de l'héritage suit des règles précises établies par le Coran. Voici un aperçu général qui peut varier selon les situations familiales spécifiques.
                        </div>

                        <div class="total-assets">
                            <h3>Calcul automatique des parts d'héritage</h3>
                            <div class="form-group">
                                <label for="totalPatrimoine">Valeur totale estimée du patrimoine (€)</label>
                                <input type="number" id="totalPatrimoine" name="totalPatrimoine" placeholder="Montant total en euros" oninput="calculateHeritage()">
                            </div>
                            <div class="total-value" id="patrimoineResult"></div>
                        </div>

                        <div class="heritage-grid" id="heritageGrid">
                            <!-- Les parts seront calculées automatiquement -->
                        </div>
                    </div>

                    <div class="form-container">
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-gift"></i> Legs testamentaires (Wasiyya)</h2>
                            
                            <div class="heritage-note">
                                <strong>Rappel :</strong> Vous ne pouvez léguer librement que le tiers (1/3) maximum de vos biens. Les deux tiers restants doivent être répartis selon les règles coraniques.
                            </div>
                            
                            <div class="legs-container">
                                <div id="legs-container"></div>
                                <button type="button" class="add-person-btn" onclick="addLegacy('legs')">
                                    <i class="fas fa-plus"></i> Ajouter un legs
                                </button>
                            </div>

                            <div class="legs-summary" id="legsSummary" style="display: none;">
                                <h4>Résumé des legs</h4>
                                <div id="legsSummaryContent"></div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-user-tie"></i> Gestion du testament</h2>
                            
                            <div class="form-group">
                                <label for="executeur">Exécuteur testamentaire recommandé</label>
                                <input type="text" id="executeur" name="executeur" placeholder="Nom et prénom de la personne de confiance">
                            </div>

                            <div class="form-group">
                                <label for="contactExecuteur">Contact de l'exécuteur</label>
                                <input type="text" id="contactExecuteur" name="contactExecuteur" placeholder="Téléphone ou email">
                            </div>

                            <div class="form-group">
                                <label for="instructionsSpeciales">Instructions spéciales</label>
                                <textarea id="instructionsSpeciales" name="instructionsSpeciales" placeholder="Toute instruction particulière pour l'exécuteur testamentaire"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Étape 6: Comptes numériques et final -->
                <div id="step6" class="form-step" style="display: none;">
                    <div class="form-container">
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-laptop"></i> Comptes numériques</h2>
                            
                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('reseauxSociaux')">
                                    <div class="category-title">
                                        <i class="fas fa-share-alt"></i> Réseaux sociaux
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="reseauxSociaux" class="category-content">
                                    <div id="reseauxSociaux-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addDigitalAccount('reseauxSociaux')">
                                        <i class="fas fa-plus"></i> Ajouter un réseau social
                                    </button>
                                </div>
                            </div>

                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('emails')">
                                    <div class="category-title">
                                        <i class="fas fa-envelope"></i> Comptes email
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="emails" class="category-content">
                                    <div id="emails-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addDigitalAccount('emails')">
                                        <i class="fas fa-plus"></i> Ajouter un email
                                    </button>
                                </div>
                            </div>

                            <div class="asset-category">
                                <div class="category-header" onclick="toggleCategory('comptesOnline')">
                                    <div class="category-title">
                                        <i class="fas fa-globe"></i> Autres comptes en ligne
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div id="comptesOnline" class="category-content">
                                    <div id="comptesOnline-container"></div>
                                    <button type="button" class="add-person-btn" onclick="addDigitalAccount('comptesOnline')">
                                        <i class="fas fa-plus"></i> Ajouter un compte
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-heart"></i> Messages personnels</h2>
                            
                            <div class="form-group">
                                <label for="messageFamille">Message pour votre famille</label>
                                <textarea id="messageFamille" name="messageFamille" placeholder="Un message personnel pour vos proches"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="conseilsEnfants">Conseils pour vos enfants</label>
                                <textarea id="conseilsEnfants" name="conseilsEnfants" placeholder="Conseils et recommandations pour vos enfants"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="dernieresVolontes">Dernières volontés</label>
                                <textarea id="dernieresVolontes" name="dernieresVolontes" placeholder="Toute autre volonté importante à transmettre"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Navigation entre étapes -->
            <div class="step-navigation">
                <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                    Étape suivante: Famille et proches <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </main>

        <div class="share-section">
            <div class="share-title">Partager Al Wassiya</div>
            <div class="share-buttons">
                <div class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <div class="share-btn facebook" onclick="shareOnFacebook()">
                    <i class="fab fa-facebook-f"></i>
                </div>
                <div class="share-btn twitter" onclick="shareOnTwitter()">
                    <i class="fab fa-twitter"></i>
                </div>
                <div class="share-btn email" onclick="shareByEmail()">
                    <i class="fas fa-envelope"></i>
                </div>
            </div>
        </div>

        <div class="footer-note">
            <p><strong>Important :</strong> Ce testament numérique est un outil d'aide à la rédaction. Pour qu'il soit juridiquement valable, il doit être rédigé, daté et signé de votre main selon les lois en vigueur dans votre pays de résidence.</p>
            
            <p><strong>Conseil :</strong> Consultez un notaire ou un juriste spécialisé en droit successoral pour vous assurer que votre testament respecte la législation locale tout en intégrant les prescriptions islamiques.</p>
            
            <p><strong>Confidentialité :</strong> Vos données restent sur votre appareil. Aucune information n'est transmise à nos serveurs. Vous êtes responsable de la sauvegarde et de la sécurité de votre testament.</p>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">
        <i class="fas fa-check"></i> Sauvegarde automatique
    </div>
    <script>
        // Variables globales
        let currentStep = 1;
        const totalSteps = 6;
        let formData = {};
        let personCounter = 0;
        let assetCounter = 0;
        let debtCounter = 0;
        let legacyCounter = 0;
        let digitalAccountCounter = 0;

        // Données pour le calcul de l'héritage
        let familyData = {
            spouse: false,
            children: 0,
            parents: 0,
            siblings: 0
        };

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadFormData();
            setupAutoSave();
            updateStepNavigation();
            
            // Gestion des champs père/mère
            document.getElementById('pere').addEventListener('change', function() {
                toggleParentDetails('pere', 'pereDetails');
            });
            
            document.getElementById('mere').addEventListener('change', function() {
                toggleParentDetails('mere', 'mereDetails');
            });
        });

        // Gestion du champ conjoint
        function toggleConjointField() {
            const situationFamiliale = document.getElementById('situationFamiliale').value;
            const conjointGroup = document.getElementById('conjointGroup');
            const conjointLabel = document.getElementById('conjointLabel');
            
            if (situationFamiliale === 'marie') {
                conjointGroup.style.display = 'block';
                conjointLabel.textContent = 'Identité de l\'époux/épouse';
            } else if (situationFamiliale === 'divorce' || situationFamiliale === 'veuf') {
                conjointGroup.style.display = 'block';
                conjointLabel.textContent = 'Identité de l\'ex-conjoint ou conjoint décédé';
            } else {
                conjointGroup.style.display = 'none';
                document.getElementById('conjoint').value = '';
            }
        }

        // Gestion des détails parents
        function toggleParentDetails(parentType, detailsId) {
            const parentSelect = document.getElementById(parentType);
            const detailsDiv = document.getElementById(detailsId);
            
            if (parentSelect.value === 'vivant' || parentSelect.value === 'decede') {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        }

        // Navigation entre étapes
        function nextStep() {
            // Validation uniquement pour l'étape 1
            if (currentStep === 1) {
                const requiredFields = document.querySelectorAll('#step1 input[required], #step1 select[required], #step1 textarea[required]');
                let isValid = true;
                
                requiredFields.forEach(field => {
                    const errorElement = document.getElementById(field.id + '-error');
                    if (!field.value.trim()) {
                        if (errorElement) errorElement.style.display = 'block';
                        field.style.borderColor = 'var(--error)';
                        isValid = false;
                    } else {
                        if (errorElement) errorElement.style.display = 'none';
                        field.style.borderColor = '';
                    }
                });
                
                if (!isValid) {
                    alert('Veuillez remplir tous les champs obligatoires avant de continuer.');
                    return;
                }
            }
            
            if (currentStep < totalSteps) {
                showStep(currentStep + 1);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }

        function showStep(step) {
            // Masquer toutes les étapes
            document.querySelectorAll('.form-step').forEach(stepElement => {
                stepElement.style.display = 'none';
            });
            
            // Afficher l'étape courante
            document.getElementById('step' + step).style.display = 'block';
            
            // Mettre à jour les points d'étape
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    dot.classList.add('completed');
                } else if (index + 1 === step) {
                    dot.classList.add('active');
                }
            });
            
            // Mettre à jour la barre de progression
            const progress = ((step - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Mettre à jour l'indicateur d'étape
            const stepTexts = [
                'Étape 1 sur 6 : Informations personnelles et volontés générales',
                'Étape 2 sur 6 : Famille et proches',
                'Étape 3 sur 6 : Biens matériels et financiers',
                'Étape 4 sur 6 : Dettes et obligations religieuses',
                'Étape 5 sur 6 : Héritage et répartition',
                'Étape 6 sur 6 : Comptes numériques et finalisation'
            ];
            document.getElementById('stepIndicator').textContent = stepTexts[step - 1];
            
            currentStep = step;
            updateStepNavigation();
            window.scrollTo(0, 0);
        }

        function updateStepNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (currentStep === 1) {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'inline-flex';
            }
            
            // Boutons avec intitulés spécifiques
            const stepButtons = {
                1: 'Étape suivante: Famille et proches <i class="fas fa-arrow-right"></i>',
                2: 'Étape suivante: Biens et patrimoine <i class="fas fa-arrow-right"></i>',
                3: 'Étape suivante: Dettes et obligations <i class="fas fa-arrow-right"></i>',
                4: 'Étape suivante: Héritage et legs <i class="fas fa-arrow-right"></i>',
                5: 'Étape suivante: Comptes numériques <i class="fas fa-arrow-right"></i>',
                6: '<i class="fas fa-file-pdf"></i> Générer le testament PDF'
            };
            
            nextBtn.innerHTML = stepButtons[currentStep];
            
            if (currentStep === totalSteps) {
                nextBtn.onclick = generatePDF;
                nextBtn.className = 'btn btn-primary';
            } else {
                nextBtn.onclick = nextStep;
                nextBtn.className = 'btn btn-primary';
            }
        }

        // Gestion des catégories
        function toggleCategory(categoryId) {
            const content = document.getElementById(categoryId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('i:last-child');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('active');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        // Génération automatique des frères/sœurs
        function generateSiblings(type) {
            const nombre = document.getElementById('nombre' + type.charAt(0).toUpperCase() + type.slice(1)).value;
            const container = document.getElementById(type + 'Details');
            container.innerHTML = '';
            
            if (nombre && nombre > 0 && nombre <= 10) {
                for (let i = 1; i <= nombre; i++) {
                    const siblingDiv = document.createElement('div');
                    siblingDiv.className = 'person-entry';
                    siblingDiv.innerHTML = `
                        <h4>${type.slice(0, -1).charAt(0).toUpperCase() + type.slice(0, -1).slice(1)} ${i}</h4>
                        <div class="form-group">
                            <label>Nom et prénom</label>
                            <input type="text" name="${type}_${i}_nom" placeholder="Nom complet">
                        </div>
                        <div class="form-group">
                            <label>Âge</label>
                            <input type="number" name="${type}_${i}_age" placeholder="Âge">
                        </div>
                        <div class="form-group">
                            <label>Contact</label>
                            <input type="text" name="${type}_${i}_contact" placeholder="Téléphone ou email">
                        </div>
                        <div class="form-group">
                            <label>Adresse</label>
                            <textarea name="${type}_${i}_adresse" placeholder="Adresse complète"></textarea>
                        </div>
                    `;
                    container.appendChild(siblingDiv);
                }
            }
            updateFamilyData();
        }

        // Génération automatique des enfants
        function generateChildren() {
            const nombre = document.getElementById('nombreEnfants').value;
            const container = document.getElementById('enfantsDetails');
            container.innerHTML = '';
            
            if (nombre && nombre > 0 && nombre <= 15) {
                for (let i = 1; i <= nombre; i++) {
                    const childDiv = document.createElement('div');
                    childDiv.className = 'person-entry';
                    childDiv.innerHTML = `
                        <h4>Enfant ${i}</h4>
                        <div class="form-group">
                            <label>Nom et prénom</label>
                            <input type="text" name="enfant_${i}_nom" placeholder="Nom complet" required>
                        </div>
                        <div class="form-group">
                            <label>Sexe</label>
                            <select name="enfant_${i}_sexe" required>
                                <option value="">Sélectionner</option>
                                <option value="masculin">Masculin</option>
                                <option value="feminin">Féminin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date de naissance</label>
                            <input type="date" name="enfant_${i}_naissance">
                        </div>
                        <div class="form-group">
                            <label>Situation</label>
                            <select name="enfant_${i}_situation">
                                <option value="">Sélectionner</option>
                                <option value="mineur">Mineur</option>
                                <option value="majeur">Majeur</option>
                                <option value="marie">Marié</option>
                                <option value="etudiant">Étudiant</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Contact/Adresse</label>
                            <textarea name="enfant_${i}_contact" placeholder="Contact et adresse si applicable"></textarea>
                        </div>
                    `;
                    container.appendChild(childDiv);
                }
            }
            updateFamilyData();
        }

        // Ajout de personnes
        function addPerson(type) {
            const container = document.getElementById(type + '-container');
            const personId = type + '_' + personCounter++;
            
            const personDiv = document.createElement('div');
            personDiv.className = 'person-entry';
            personDiv.id = personId;
            
            personDiv.innerHTML = `
                <div class="form-group">
                    <label>Nom et prénom</label>
                    <input type="text" name="${personId}_nom" placeholder="Nom complet">
                </div>
                <div class="form-group">
                    <label>Relation</label>
                    <input type="text" name="${personId}_relation" placeholder="Ex: Oncle, Tante, Cousin, etc.">
                </div>
                <div class="form-group">
                    <label>Contact</label>
                    <input type="text" name="${personId}_contact" placeholder="Téléphone ou email">
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <textarea name="${personId}_adresse" placeholder="Adresse complète"></textarea>
                </div>
                <button type="button" class="remove-person-btn" onclick="removePerson('${personId}')">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            `;
            
            container.appendChild(personDiv);
            updateFamilyData();
        }

        function removePerson(personId) {
            document.getElementById(personId).remove();
            updateFamilyData();
        }

        // Ajout de biens
        function addAsset(type) {
            const container = document.getElementById(type + '-container');
            const assetId = type + '_' + assetCounter++;
            
            const assetDiv = document.createElement('div');
            assetDiv.className = 'asset-entry';
            assetDiv.id = assetId;
            
            let specificFields = '';
            if (type === 'immobilier') {
                specificFields = `
                    <div class="form-group">
                        <label>Type de bien</label>
                        <select name="${assetId}_type">
                            <option value="">Sélectionner</option>
                            <option value="maison">Maison</option>
                            <option value="appartement">Appartement</option>
                            <option value="terrain">Terrain</option>
                            <option value="local-commercial">Local commercial</option>
                            <option value="garage">Garage/Parking</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Adresse du bien</label>
                        <textarea name="${assetId}_adresse" placeholder="Adresse complète du bien"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Surface (m²)</label>
                        <input type="number" name="${assetId}_surface" placeholder="Surface en m²">
                    </div>`;
            } else if (type === 'comptes') {
                specificFields = `
                    <div class="form-group">
                        <label>Banque</label>
                        <input type="text" name="${assetId}_banque" placeholder="Nom de la banque">
                    </div>
                    <div class="form-group">
                        <label>Type de compte</label>
                        <select name="${assetId}_type">
                            <option value="">Sélectionner</option>
                            <option value="courant">Compte courant</option>
                            <option value="epargne">Compte épargne</option>
                            <option value="livret">Livret A/LDDS</option>
                            <option value="pea">PEA</option>
                            <option value="assurance-vie">Assurance vie</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Numéro de compte (optionnel)</label>
                        <input type="text" name="${assetId}_numero" placeholder="Numéro de compte">
                    </div>`;
            } else if (type === 'cartes') {
                specificFields = `
                    <div class="form-group">
                        <label>Type de carte</label>
                        <select name="${assetId}_type">
                            <option value="">Sélectionner</option>
                            <option value="debit">Carte de débit</option>
                            <option value="credit">Carte de crédit</option>
                            <option value="prepayee">Carte prépayée</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Banque émettrice</label>
                        <input type="text" name="${assetId}_banque" placeholder="Nom de la banque">
                    </div>
                    <div class="form-group">
                        <label>4 derniers chiffres</label>
                        <input type="text" name="${assetId}_numero" placeholder="**** **** **** 1234" maxlength="4">
                    </div>`;
            } else if (type === 'applications') {
                specificFields = `
                    <div class="form-group">
                        <label>Type d'application</label>
                        <select name="${assetId}_type">
                            <option value="">Sélectionner</option>
                            <option value="bancaire">Application bancaire</option>
                            <option value="paiement">Application de paiement (PayPal, etc.)</option>
                            <option value="crypto">Portefeuille crypto</option>
                            <option value="investissement">Application d'investissement</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nom d'utilisateur/Email</label>
                        <input type="text" name="${assetId}_username" placeholder="Identifiant de connexion">
                    </div>`;
            } else if (type === 'materiel') {
                specificFields = `
                    <div class="form-group">
                        <label>Catégorie</label>
                        <select name="${assetId}_categorie">
                            <option value="">Sélectionner</option>
                            <option value="vehicule">Véhicule</option>
                            <option value="bijoux">Bijoux</option>
                            <option value="electronique">Électronique</option>
                            <option value="mobilier">Mobilier</option>
                            <option value="art">Œuvre d'art</option>
                            <option value="collection">Collection</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>`;
            } else if (type === 'personnels') {
                specificFields = `
                    <div class="form-group">
                        <label>Type de bien personnel</label>
                        <select name="${assetId}_type">
                            <option value="">Sélectionner</option>
                            <option value="vetements">Vêtements</option>
                            <option value="livres">Livres</option>
                            <option value="photos">Photos/Souvenirs</option>
                            <option value="documents">Documents personnels</option>
                            <option value="religieux">Objets religieux</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>`;
            }
            
            assetDiv.innerHTML = `
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" name="${assetId}_description" placeholder="Description du bien" required>
                </div>
                ${specificFields}
                <div class="form-group">
                    <label>Valeur estimée (€)</label>
                    <input type="number" name="${assetId}_valeur" placeholder="Valeur en euros">
                </div>
                <div class="form-group">
                    <label>État/Condition</label>
                    <select name="${assetId}_etat">
                        <option value="">Sélectionner</option>
                        <option value="excellent">Excellent</option>
                        <option value="bon">Bon</option>
                        <option value="moyen">Moyen</option>
                        <option value="mauvais">Mauvais</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="${assetId}_notes" placeholder="Informations complémentaires"></textarea>
                </div>
                <button type="button" class="remove-person-btn" onclick="removeAsset('${assetId}')">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            `;
            
            container.appendChild(assetDiv);
        }

        function removeAsset(assetId) {
            document.getElementById(assetId).remove();
        }

        // Ajout de dettes
        function addDebt(type) {
            const container = document.getElementById(type + '-container');
            const debtId = type + '_' + debtCounter++;
            
            const debtDiv = document.createElement('div');
            debtDiv.className = 'asset-entry';
            debtDiv.id = debtId;
            
            const isDebt = type === 'dettes';
            const title = isDebt ? 'dette' : 'créance';
            
            debtDiv.innerHTML = `
                <div class="form-group">
                    <label>Type de ${title}</label>
                    <select name="${debtId}_type">
                        <option value="">Sélectionner</option>
                        ${isDebt ? `
                            <option value="pret">Prêt bancaire</option>
                            <option value="credit">Crédit à la consommation</option>
                            <option value="hypotheque">Hypothèque</option>
                            <option value="personnel">Dette personnelle</option>
                            <option value="impots">Impôts</option>
                            <option value="factures">Factures impayées</option>
                        ` : `
                            <option value="pret">Prêt accordé</option>
                            <option value="salaire">Salaire dû</option>
                            <option value="remboursement">Remboursement attendu</option>
                            <option value="depot">Dépôt de garantie</option>
                        `}
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description de la ${title}</label>
                    <input type="text" name="${debtId}_description" placeholder="Description" required>
                </div>
                <div class="form-group">
                    <label>${isDebt ? 'Créancier' : 'Débiteur'}</label>
                    <input type="text" name="${debtId}_personne" placeholder="Nom de la personne ou organisme">
                </div>
                <div class="form-group">
                    <label>Montant (€)</label>
                    <input type="number" name="${debtId}_montant" placeholder="Montant en euros">
                </div>
                <div class="form-group">
                    <label>Échéance</label>
                    <input type="date" name="${debtId}_echeance">
                </div>
                <div class="form-group">
                    <label>Contact</label>
                    <input type="text" name="${debtId}_contact" placeholder="Téléphone ou email">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="${debtId}_notes" placeholder="Détails supplémentaires"></textarea>
                </div>
                <button type="button" class="remove-person-btn" onclick="removeDebt('${debtId}')">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            `;
            
            container.appendChild(debtDiv);
        }

        function removeDebt(debtId) {
            document.getElementById(debtId).remove();
        }

        // Ajout de legs
        function addLegacy(type) {
            const container = document.getElementById(type + '-container');
            const legacyId = type + '_' + legacyCounter++;
            
            const legacyDiv = document.createElement('div');
            legacyDiv.className = 'leg-entry';
            legacyDiv.id = legacyId;
            
            legacyDiv.innerHTML = `
                <div class="form-group">
                    <label>Bénéficiaire</label>
                    <input type="text" name="${legacyId}_beneficiaire" placeholder="Nom du bénéficiaire" required>
                </div>
                <div class="form-group">
                    <label>Relation avec le bénéficiaire</label>
                    <input type="text" name="${legacyId}_relation" placeholder="Ex: Ami, Association, Mosquée">
                </div>
                <div class="form-group">
                    <label>Type de legs</label>
                    <select name="${legacyId}_type">
                        <option value="">Sélectionner</option>
                        <option value="argent">Somme d'argent</option>
                        <option value="bien">Bien matériel spécifique</option>
                        <option value="pourcentage">Pourcentage du tiers</option>
                        <option value="usufruit">Usufruit</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Objet du legs</label>
                    <textarea name="${legacyId}_objet" placeholder="Description détaillée de ce qui est légué" required></textarea>
                </div>
                <div class="form-group">
                    <label>Valeur estimée (€)</label>
                    <input type="number" name="${legacyId}_valeur" placeholder="Valeur en euros" oninput="calculateLegacySummary()">
                </div>
                <div class="form-group">
                    <label>Conditions particulières</label>
                    <textarea name="${legacyId}_conditions" placeholder="Conditions d'attribution du legs (âge, situation, etc.)"></textarea>
                </div>
                <div class="leg-amount">
                    Rappel : Ce legs sera déduit du tiers disponible (maximum 1/3 du patrimoine)
                </div>
                <button type="button" class="remove-person-btn" onclick="removeLegacy('${legacyId}')">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            `;
            
            container.appendChild(legacyDiv);
            calculateLegacySummary();
        }

        function removeLegacy(legacyId) {
            document.getElementById(legacyId).remove();
            calculateLegacySummary();
        }

        // Ajout de comptes numériques
        function addDigitalAccount(type) {
            const container = document.getElementById(type + '-container');
            const accountId = type + '_' + digitalAccountCounter++;
            
            const accountDiv = document.createElement('div');
            accountDiv.className = 'asset-entry';
            accountDiv.id = accountId;
            
            let specificFields = '';
            if (type === 'reseauxSociaux') {
                specificFields = `
                    <div class="form-group">
                        <label>Plateforme</label>
                        <select name="${accountId}_plateforme">
                            <option value="">Sélectionner</option>
                            <option value="facebook">Facebook</option>
                            <option value="instagram">Instagram</option>
                            <option value="twitter">Twitter/X</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="tiktok">TikTok</option>
                            <option value="snapchat">Snapchat</option>
                            <option value="youtube">YouTube</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>`;
            } else if (type === 'emails') {
                specificFields = `
                    <div class="form-group">
                        <label>Fournisseur</label>
                        <select name="${accountId}_fournisseur">
                            <option value="">Sélectionner</option>
                            <option value="gmail">Gmail</option>
                            <option value="outlook">Outlook/Hotmail</option>
                            <option value="yahoo">Yahoo</option>
                            <option value="icloud">iCloud</option>
                            <option value="orange">Orange</option>
                            <option value="free">Free</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>`;
            }
            
            accountDiv.innerHTML = `
                <div class="form-group">
                    <label>Nom du service</label>
                    <input type="text" name="${accountId}_service" placeholder="Nom du service ou site" required>
                </div>
                ${specificFields}
                <div class="form-group">
                    <label>Email/Nom d'utilisateur</label>
                    <input type="text" name="${accountId}_username" placeholder="Identifiant de connexion">
                </div>
                <div class="form-group">
                    <label>Instructions particulières</label>
                    <select name="${accountId}_action">
                        <option value="">Que faire de ce compte ?</option>
                        <option value="supprimer">Supprimer le compte</option>
                        <option value="memorial">Transformer en mémorial</option>
                        <option value="transferer">Transférer à la famille</option>
                        <option value="conserver">Conserver tel quel</option>
                        <option value="autre">Autre instruction</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Personne de confiance</label>
                    <input type="text" name="${accountId}_contact" placeholder="Personne qui peut gérer ce compte">
                </div>
                <div class="form-group">
                    <label>Notes supplémentaires</label>
                    <textarea name="${accountId}_notes" placeholder="Informations importantes concernant ce compte"></textarea>
                </div>
                <button type="button" class="remove-person-btn" onclick="removeDigitalAccount('${accountId}')">
                    <i class="fas fa-trash"></i> Supprimer
                </button>
            `;
            
            container.appendChild(accountDiv);
        }

        function removeDigitalAccount(accountId) {
            document.getElementById(accountId).remove();
        }

        // Calculateur de Zakat
        function calculateZakat() {
            const nissab = parseFloat(document.getElementById('nissab').value) || 4265;
            const montant = parseFloat(document.getElementById('montantZakat').value) || 0;
            const result = document.getElementById('zakatResult');
            
            if (montant > 0) {
                result.style.display = 'block';
                
                if (montant >= nissab) {
                    const exceeding = montant - nissab;
                    const zakatAmount = exceeding * 0.025; // 2.5% sur ce qui dépasse le nisab
                    
                    result.innerHTML = `
                        <div style="background: var(--success); color: white; padding: 15px; border-radius: var(--radius); margin-bottom: 10px;">
                            <strong>Zakat obligatoire</strong>
                        </div>
                        <p><strong>Montant du patrimoine :</strong> ${montant.toFixed(2)} €</p>
                        <p><strong>Nisâb (seuil) :</strong> ${nissab.toFixed(2)} €</p>
                        <p><strong>Montant dépassant le Nisâb :</strong> ${exceeding.toFixed(2)} €</p>
                        <p><strong>Zakat à verser (2,5%) :</strong> <span style="color: var(--primary); font-weight: bold; font-size: 1.2em;">${zakatAmount.toFixed(2)} €</span></p>
                        <small style="color: var(--secondary);">La Zakat est calculée sur le montant qui dépasse le Nisâb.</small>
                    `;
                } else {
                    const manquant = nissab - montant;
                    result.innerHTML = `
                        <div style="background: var(--secondary); color: white; padding: 15px; border-radius: var(--radius); margin-bottom: 10px;">
                            <strong>Zakat non obligatoire</strong>
                        </div>
                        <p><strong>Montant du patrimoine :</strong> ${montant.toFixed(2)} €</p>
                        <p><strong>Nisâb (seuil) :</strong> ${nissab.toFixed(2)} €</p>
                        <p><strong>Il manque :</strong> ${manquant.toFixed(2)} € pour atteindre le Nisâb</p>
                        <small style="color: var(--secondary);">Votre patrimoine ne dépasse pas le seuil du Nisâb. La Zakat n'est pas obligatoire.</small>
                    `;
                }
            } else {
                result.style.display = 'none';
            }
        }

        // Mise à jour des données familiales
        function updateFamilyData() {
            // Compter les membres de la famille
            familyData.spouse = document.querySelectorAll('#conjoints-container .person-entry').length > 0 || 
                               document.getElementById('situationFamiliale').value === 'marie';
            familyData.children = document.querySelectorAll('#enfants-container .person-entry').length + 
                                 (parseInt(document.getElementById('nombreEnfants').value) || 0);
            familyData.parents = (document.getElementById('pere').value === 'vivant' ? 1 : 0) + 
                                (document.getElementById('mere').value === 'vivante' ? 1 : 0);
            familyData.siblings = (parseInt(document.getElementById('nombreFreres').value) || 0) + 
                                 (parseInt(document.getElementById('nombreSoeurs').value) || 0);
        }

        // Calculateur d'héritage
        function calculateHeritage() {
            const totalValue = parseFloat(document.getElementById('totalPatrimoine').value) || 0;
            const result = document.getElementById('patrimoineResult');
            const grid = document.getElementById('heritageGrid');
            
            if (totalValue > 0) {
                updateFamilyData();
                
                const shares = calculateIslamicInheritance(totalValue, familyData);
                result.innerHTML = `
                    <strong>Patrimoine total :</strong> ${totalValue.toFixed(2)} €<br>
                    <small>Répartition selon les règles coraniques de l'héritage</small>
                `;
                
                // Afficher la répartition
                grid.innerHTML = '';
                let totalDistributed = 0;
                
                shares.forEach(share => {
                    const shareDiv = document.createElement('div');
                    shareDiv.className = 'heritage-item';
                    shareDiv.innerHTML = `
                        <div class="heritage-item-title">${share.heir}</div>
                        <div class="heritage-share">${share.fraction} = ${share.amount.toFixed(2)} €</div>
                        <small>${share.description || ''}</small>
                    `;
                    grid.appendChild(shareDiv);
                    totalDistributed += share.amount;
                });
                
                // Ajouter une note si il reste un résidu
                const remaining = totalValue - totalDistributed;
                if (remaining > 1) {
                    const remainingDiv = document.createElement('div');
                    remainingDiv.className = 'heritage-item';
                    remainingDiv.style.borderLeft = '4px solid var(--accent)';
                    remainingDiv.innerHTML = `
                        <div class="heritage-item-title">Résidu (Radd)</div>
                        <div class="heritage-share">${remaining.toFixed(2)} €</div>
                        <small>À répartir entre les héritiers selon les règles du Radd</small>
                    `;
                    grid.appendChild(remainingDiv);
                }
            } else {
                result.innerHTML = '';
                grid.innerHTML = '<p style="text-align: center; color: var(--secondary);">Saisissez la valeur de votre patrimoine pour voir la répartition</p>';
            }
        }

        // Calcul simplifié de l'héritage selon les règles islamiques
        function calculateIslamicInheritance(totalValue, family) {
            const shares = [];
            let remainingFraction = 1; // 100%
            
            // Conjoint
            if (family.spouse) {
                if (family.children > 0) {
                    shares.push({
                        heir: 'Conjoint survivant',
                        fraction: '1/8',
                        amount: totalValue / 8,
                        description: 'Part du conjoint en présence d\'enfants'
                    });
                    remainingFraction -= 1/8;
                } else {
                    shares.push({
                        heir: 'Conjoint survivant',
                        fraction: '1/4',
                        amount: totalValue / 4,
                        description: 'Part du conjoint sans enfant'
                    });
                    remainingFraction -= 1/4;
                }
            }
            
            // Parents
            if (family.parents > 0) {
                if (family.children > 0) {
                    const parentShare = totalValue / 6;
                    if (family.parents === 2) {
                        shares.push({
                            heir: 'Père et Mère (chacun)',
                            fraction: '1/6 chacun',
                            amount: parentShare * 2,
                            description: 'Part des parents en présence d\'enfants'
                        });
                        remainingFraction -= 1/3;
                    } else {
                        shares.push({
                            heir: family.parents === 1 ? 'Parent survivant' : 'Parents',
                            fraction: '1/6',
                            amount: parentShare,
                            description: 'Part du parent en présence d\'enfants'
                        });
                        remainingFraction -= 1/6;
                    }
                } else {
                    if (family.parents === 2) {
                        shares.push({
                            heir: 'Mère',
                            fraction: '1/3',
                            amount: totalValue / 3,
                            description: 'Part de la mère sans enfant'
                        });
                        remainingFraction -= 1/3;
                    }
                }
            }
            
            // Enfants
            if (family.children > 0) {
                const childrenAmount = totalValue * remainingFraction;
                shares.push({
                    heir: `Enfants (${family.children})`,
                    fraction: 'Reste (Asaba)',
                    amount: childrenAmount,
                    description: 'Les fils héritent le double des filles'
                });
                remainingFraction = 0;
            }
            
            // Frères et sœurs (si pas d'enfants ni de père)
            if (family.children === 0 && family.siblings > 0 && remainingFraction > 0) {
                const siblingsAmount = totalValue * remainingFraction;
                shares.push({
                    heir: `Frères et Sœurs (${family.siblings})`,
                    fraction: 'Reste (Asaba)',
                    amount: siblingsAmount,
                    description: 'Héritent en l\'absence d\'enfants et de père'
                });
                remainingFraction = 0;
            }
            
            return shares;
        }

        // Calcul du résumé des legs
        function calculateLegacySummary() {
            const legacyInputs = document.querySelectorAll('input[name*="legs_"][name*="_valeur"]');
            let totalLegacies = 0;
            const totalValue = parseFloat(document.getElementById('totalPatrimoine').value) || 0;
            
            legacyInputs.forEach(input => {
                if (input.value) {
                    totalLegacies += parseFloat(input.value) || 0;
                }
            });
            
            const summary = document.getElementById('legsSummary');
            const content = document.getElementById('legsSummaryContent');
            
            if (totalLegacies > 0 && totalValue > 0) {
                summary.style.display = 'block';
                const maxLegacy = totalValue / 3;
                const percentage = (totalLegacies / totalValue * 100).toFixed(1);
                const isValid = totalLegacies <= maxLegacy;
                
                content.innerHTML = `
                    <p><strong>Total des legs :</strong> ${totalLegacies.toFixed(2)} € (${percentage}% du patrimoine)</p>
                    <p><strong>Maximum autorisé (1/3) :</strong> ${maxLegacy.toFixed(2)} €</p>
                    <p><strong>Restant disponible :</strong> ${Math.max(0, maxLegacy - totalLegacies).toFixed(2)} €</p>
                    ${!isValid ? `<p class="warning">⚠️ Attention : Le total des legs dépasse le tiers autorisé de ${(totalLegacies - maxLegacy).toFixed(2)} € !</p>` : 
                      `<p style="color: var(--success);">✓ Les legs respectent la limite du tiers</p>`}
                `;
            } else {
                summary.style.display = 'none';
            }
        }
        // Sauvegarde automatique
        function setupAutoSave() {
            const form = document.getElementById('testamentForm');
            
            form.addEventListener('input', function(e) {
                saveFormData();
                showSaveIndicator();
            });
            
            form.addEventListener('change', function(e) {
                saveFormData();
                showSaveIndicator();
            });
        }

        function saveFormData() {
            const form = document.getElementById('testamentForm');
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            localStorage.setItem('testamentData', JSON.stringify(data));
        }

        function loadFormData() {
            const savedData = localStorage.getItem('testamentData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                for (let [key, value] of Object.entries(data)) {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        element.value = value;
                    }
                }
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('visible');
            
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // Fonctions de partage
        function shareOnWhatsApp() {
            const text = "Découvrez Al Wassiya (الوصية), un outil pour créer facilement votre testament islamique selon le Coran et la Sunna.";
            const url = window.location.href;
            window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');
        }

        function shareOnFacebook() {
            const url = window.location.href;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
        }

        function shareOnTwitter() {
            const text = "Créez votre testament islamique avec Al Wassiya (الوصية)";
            const url = window.location.href;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }

        function shareByEmail() {
            const subject = "Al Wassiya (الوصية) - Testament Islamique";
            const body = "Découvrez Al Wassiya, un outil pour créer facilement votre testament islamique selon le Coran et la Sunna.\n\n" + window.location.href;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        // Fonction de génération PDF adaptée du code 2
        function generatePDF() {
            // Sauvegarder les données avant génération
            saveFormData();
            
            // Récupérer toutes les données du formulaire
            const formData = new FormData(document.getElementById('testamentForm'));
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Créer le PDF avec jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = 20;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            
            // Fonction pour ajouter une nouvelle page si nécessaire
            function checkPageBreak(doc, yPos, increment = 10) {
                if (yPos + increment > pageHeight - margin) {
                    doc.addPage();
                    return margin;
                }
                return yPos;
            }
            
            // Fonction pour ajouter du texte avec retour à la ligne automatique
            function addWrappedText(doc, text, x, y, maxWidth, lineHeight = 7) {
                const lines = doc.splitTextToSize(text, maxWidth);
                lines.forEach((line, index) => {
                    y = checkPageBreak(doc, y, lineHeight);
                    doc.text(line, x, y);
                    y += lineHeight;
                });
                return y;
            }
            
            try {
                // En-tête du document
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('AL WASSIYA', 105, yPosition, { align: 'center' });
                yPosition += 8;
                
                doc.setFontSize(16);
                doc.text('الوصية', 105, yPosition, { align: 'center' });
                yPosition += 10;
                
                doc.setFontSize(16);
                doc.text('Testament Islamique', 105, yPosition, { align: 'center' });
                yPosition += 15;
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text('بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ', 105, yPosition, { align: 'center' });
                yPosition += 15;
                
                // Date de création
                const today = new Date().toLocaleDateString('fr-FR');
                doc.setFontSize(10);
                doc.text(`Document généré le : ${today}`, margin, yPosition);
                yPosition += 15;
                
                // Section 1: Informations personnelles
                yPosition = checkPageBreak(doc, yPosition, 20);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('1. INFORMATIONS PERSONNELLES', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                if (data.prenom || data.nom) {
                    yPosition = addWrappedText(doc, `Nom et prénom : ${data.prenom || ''} ${data.nom || ''}`, margin, yPosition, 170);
                }
                
                if (data.sexe) {
                    yPosition = addWrappedText(doc, `Sexe : ${data.sexe}`, margin, yPosition, 170);
                }
                
                if (data.dateNaissance) {
                    const dateNaissance = new Date(data.dateNaissance).toLocaleDateString('fr-FR');
                    yPosition = addWrappedText(doc, `Date de naissance : ${dateNaissance}`, margin, yPosition, 170);
                }
                
                if (data.lieuNaissance) {
                    yPosition = addWrappedText(doc, `Lieu de naissance : ${data.lieuNaissance}`, margin, yPosition, 170);
                }
                
                if (data.adresse) {
                    yPosition = addWrappedText(doc, `Adresse : ${data.adresse}`, margin, yPosition, 170);
                }
                
                if (data.nationalite) {
                    yPosition = addWrappedText(doc, `Nationalité : ${data.nationalite}`, margin, yPosition, 170);
                }
                
                if (data.situationFamiliale) {
                    yPosition = addWrappedText(doc, `Situation familiale : ${data.situationFamiliale}`, margin, yPosition, 170);
                }
                
                if (data.conjoint) {
                    yPosition = addWrappedText(doc, `Conjoint : ${data.conjoint}`, margin, yPosition, 170);
                }
                
                yPosition += 10;
                
                // Section 2: Volontés générales
                yPosition = checkPageBreak(doc, yPosition, 20);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('2. VOLONTÉS GÉNÉRALES', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                if (data.volontesObseques) {
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, 'Volontés concernant les obsèques :', margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    yPosition = addWrappedText(doc, data.volontesObseques, margin, yPosition, 170);
                    yPosition += 5;
                }
                
                if (data.recommandationsFamille) {
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, 'Recommandations à la famille :', margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    yPosition = addWrappedText(doc, data.recommandationsFamille, margin, yPosition, 170);
                    yPosition += 5;
                }
                
                if (data.executeurTestament) {
                    yPosition = addWrappedText(doc, `Exécuteur testamentaire suggéré : ${data.executeurTestament}`, margin, yPosition, 170);
                }
                
                if (data.contactExecuteur) {
                    yPosition = addWrappedText(doc, `Contact de l'exécuteur : ${data.contactExecuteur}`, margin, yPosition, 170);
                }
                
                if (data.autresVolontes) {
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, 'Autres volontés :', margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    yPosition = addWrappedText(doc, data.autresVolontes, margin, yPosition, 170);
                }
                
                yPosition += 10;
                
                // Section 3: Famille et proches
                yPosition = checkPageBreak(doc, yPosition, 20);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('3. FAMILLE ET PROCHES', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                // Parents
                if (data.pere || data.mere) {
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, 'Parents :', margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    
                    if (data.pere) {
                        yPosition = addWrappedText(doc, `Père : ${data.pere}`, margin + 10, yPosition, 160);
                        if (data.prenomPere) {
                            yPosition = addWrappedText(doc, `  Nom : ${data.prenomPere}`, margin + 10, yPosition, 160);
                        }
                        if (data.contactPere) {
                            yPosition = addWrappedText(doc, `  Contact : ${data.contactPere}`, margin + 10, yPosition, 160);
                        }
                    }
                    
                    if (data.mere) {
                        yPosition = addWrappedText(doc, `Mère : ${data.mere}`, margin + 10, yPosition, 160);
                        if (data.prenomMere) {
                            yPosition = addWrappedText(doc, `  Nom : ${data.prenomMere}`, margin + 10, yPosition, 160);
                        }
                        if (data.contactMere) {
                            yPosition = addWrappedText(doc, `  Contact : ${data.contactMere}`, margin + 10, yPosition, 160);
                        }
                    }
                    yPosition += 5;
                }
                
                // Frères et sœurs
                if (data.nombreFreres || data.nombreSoeurs) {
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, 'Frères et Sœurs :', margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    
                    if (data.nombreFreres) {
                        yPosition = addWrappedText(doc, `Nombre de frères : ${data.nombreFreres}`, margin + 10, yPosition, 160);
                    }
                    if (data.nombreSoeurs) {
                        yPosition = addWrappedText(doc, `Nombre de sœurs : ${data.nombreSoeurs}`, margin + 10, yPosition, 160);
                    }
                    
                    // Détails des frères/sœurs
                    Object.keys(data).forEach(key => {
                        if ((key.startsWith('freres_') || key.startsWith('soeurs_')) && key.endsWith('_nom') && data[key]) {
                            const baseId = key.replace('_nom', '');
                            yPosition = addWrappedText(doc, `- ${data[baseId + '_nom']}`, margin + 10, yPosition, 160);
                            if (data[baseId + '_contact']) {
                                yPosition = addWrappedText(doc, `  Contact : ${data[baseId + '_contact']}`, margin + 10, yPosition, 160);
                            }
                        }
                    });
                    yPosition += 5;
                }
                
                // Enfants
                if (data.nombreEnfants) {
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, `Enfants (${data.nombreEnfants}) :`, margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    
                    Object.keys(data).forEach(key => {
                        if (key.startsWith('enfant_') && key.endsWith('_nom') && data[key]) {
                            const baseId = key.replace('_nom', '');
                            let enfantInfo = `- ${data[baseId + '_nom']}`;
                            if (data[baseId + '_sexe']) {
                                enfantInfo += ` (${data[baseId + '_sexe']})`;
                            }
                            yPosition = addWrappedText(doc, enfantInfo, margin + 10, yPosition, 160);
                            if (data[baseId + '_naissance']) {
                                const dateNaissance = new Date(data[baseId + '_naissance']).toLocaleDateString('fr-FR');
                                yPosition = addWrappedText(doc, `  Né(e) le : ${dateNaissance}`, margin + 10, yPosition, 160);
                            }
                            if (data[baseId + '_situation']) {
                                yPosition = addWrappedText(doc, `  Situation : ${data[baseId + '_situation']}`, margin + 10, yPosition, 160);
                            }
                        }
                    });
                    yPosition += 5;
                }
                
                // Autres personnes ajoutées dynamiquement
                const personTypes = ['conjoints', 'amis', 'parents'];
                const typeLabels = {
                    'conjoints': 'Conjoints',
                    'amis': 'Amis proches',
                    'parents': 'Autres parents'
                };
                
                personTypes.forEach(type => {
                    const persons = [];
                    Object.keys(data).forEach(key => {
                        if (key.startsWith(type + '_') && key.endsWith('_nom') && data[key]) {
                            const baseId = key.replace('_nom', '');
                            persons.push({
                                nom: data[baseId + '_nom'] || '',
                                relation: data[baseId + '_relation'] || '',
                                contact: data[baseId + '_contact'] || ''
                            });
                        }
                    });
                    
                    if (persons.length > 0) {
                        doc.setFont(undefined, 'bold');
                        yPosition = addWrappedText(doc, typeLabels[type] + ':', margin, yPosition, 170);
                        doc.setFont(undefined, 'normal');
                        
                        persons.forEach(person => {
                            yPosition = addWrappedText(doc, `- ${person.nom}${person.relation ? ' (' + person.relation + ')' : ''}`, margin + 10, yPosition, 160);
                            if (person.contact) {
                                yPosition = addWrappedText(doc, `  Contact : ${person.contact}`, margin + 10, yPosition, 160);
                            }
                        });
                        yPosition += 5;
                    }
                });
                
                if (data.autresProches) {
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, 'Autres personnes à mentionner :', margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    yPosition = addWrappedText(doc, data.autresProches, margin, yPosition, 170);
                }
                
                yPosition += 10;
                
                // Section 4: Biens et possessions
                yPosition = checkPageBreak(doc, yPosition, 20);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('4. BIENS ET POSSESSIONS', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                // Traitement des biens
                const assetTypes = ['immobilier', 'materiel', 'personnels', 'comptes', 'cartes', 'applications'];
                const assetLabels = {
                    'immobilier': 'Biens immobiliers',
                    'materiel': 'Biens matériels',
                    'personnels': 'Biens personnels',
                    'comptes': 'Comptes bancaires',
                    'cartes': 'Cartes bancaires',
                    'applications': 'Applications bancaires'
                };
                
                assetTypes.forEach(type => {
                    const assets = [];
                    Object.keys(data).forEach(key => {
                        if (key.startsWith(type + '_') && key.endsWith('_description') && data[key]) {
                            const baseId = key.replace('_description', '');
                            assets.push({
                                description: data[baseId + '_description'] || '',
                                valeur: data[baseId + '_valeur'] || '',
                                type: data[baseId + '_type'] || '',
                                notes: data[baseId + '_notes'] || '',
                                banque: data[baseId + '_banque'] || '',
                                surface: data[baseId + '_surface'] || ''
                            });
                        }
                    });
                    
                    if (assets.length > 0) {
                        doc.setFont(undefined, 'bold');
                        yPosition = addWrappedText(doc, assetLabels[type] + ':', margin, yPosition, 170);
                        doc.setFont(undefined, 'normal');
                        
                        assets.forEach(asset => {
                            yPosition = addWrappedText(doc, `- ${asset.description}`, margin + 10, yPosition, 160);
                            if (asset.type) {
                                yPosition = addWrappedText(doc, `  Type : ${asset.type}`, margin + 10, yPosition, 160);
                            }
                            if (asset.valeur) {
                                yPosition = addWrappedText(doc, `  Valeur : ${asset.valeur} €`, margin + 10, yPosition, 160);
                            }
                            if (asset.banque) {
                                yPosition = addWrappedText(doc, `  Banque : ${asset.banque}`, margin + 10, yPosition, 160);
                            }
                            if (asset.surface) {
                                yPosition = addWrappedText(doc, `  Surface : ${asset.surface} m²`, margin + 10, yPosition, 160);
                            }
                            if (asset.notes) {
                                yPosition = addWrappedText(doc, `  Notes : ${asset.notes}`, margin + 10, yPosition, 160);
                            }
                            yPosition += 3;
                        });
                        yPosition += 5;
                    }
                });
                
                // Zakat
                if (data.montantZakat) {
                    yPosition = checkPageBreak(doc, yPosition, 15);
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, 'Calcul de la Zakat :', margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    
                    const nissab = parseFloat(data.nissab) || 4265;
                    const montant = parseFloat(data.montantZakat);
                    
                    if (montant >= nissab) {
                        const exceeding = montant - nissab;
                        const zakatAmount = exceeding * 0.025;
                        yPosition = addWrappedText(doc, `Patrimoine imposable : ${montant} €`, margin + 10, yPosition, 160);
                        yPosition = addWrappedText(doc, `Nisâb : ${nissab} €`, margin + 10, yPosition, 160);
                        yPosition = addWrappedText(doc, `Montant dépassant le Nisâb : ${exceeding.toFixed(2)} €`, margin + 10, yPosition, 160);
                        yPosition = addWrappedText(doc, `Zakat à verser : ${zakatAmount.toFixed(2)} €`, margin + 10, yPosition, 160);
                    } else {
                        yPosition = addWrappedText(doc, `Patrimoine : ${montant} € (inférieur au Nisâb de ${nissab} €)`, margin + 10, yPosition, 160);
                        yPosition = addWrappedText(doc, `Zakat non obligatoire`, margin + 10, yPosition, 160);
                    }
                    yPosition += 5;
                }
                
                yPosition += 10;
                
                // Section 5: Dettes et obligations
                yPosition = checkPageBreak(doc, yPosition, 20);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('5. DETTES ET OBLIGATIONS', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                // Traitement des dettes et créances
                const debtTypes = ['dettes', 'creances'];
                const debtLabels = {
                    'dettes': 'Dettes à payer',
                    'creances': 'Créances à récupérer'
                };
                
                debtTypes.forEach(type => {
                    const debts = [];
                    Object.keys(data).forEach(key => {
                        if (key.startsWith(type + '_') && key.endsWith('_description') && data[key]) {
                            const baseId = key.replace('_description', '');
                            debts.push({
                                description: data[baseId + '_description'] || '',
                                montant: data[baseId + '_montant'] || '',
                                personne: data[baseId + '_personne'] || '',
                                contact: data[baseId + '_contact'] || ''
                            });
                        }
                    });
                    
                    if (debts.length > 0) {
                        doc.setFont(undefined, 'bold');
                        yPosition = addWrappedText(doc, debtLabels[type] + ':', margin, yPosition, 170);
                        doc.setFont(undefined, 'normal');
                        
                        debts.forEach(debt => {
                            yPosition = addWrappedText(doc, `- ${debt.description}`, margin + 10, yPosition, 160);
                            if (debt.montant) {
                                yPosition = addWrappedText(doc, `  Montant : ${debt.montant} €`, margin + 10, yPosition, 160);
                            }
                            if (debt.personne) {
                                yPosition = addWrappedText(doc, `  Personne : ${debt.personne}`, margin + 10, yPosition, 160);
                            }
                            if (debt.contact) {
                                yPosition = addWrappedText(doc, `  Contact : ${debt.contact}`, margin + 10, yPosition, 160);
                            }
                        });
                        yPosition += 5;
                    }
                });
                
                // Obligations religieuses
                if (data.zakatDue || data.hadjStatus || data.jeuneManque || data.priereManque || data.sadaqa) {
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, 'Obligations religieuses :', margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    
                    if (data.zakatDue) {
                        yPosition = addWrappedText(doc, `Zakat non versée : ${data.zakatDue}`, margin + 10, yPosition, 160);
                    }
                    if (data.hadjStatus) {
                        yPosition = addWrappedText(doc, `Statut du Hajj : ${data.hadjStatus}`, margin + 10, yPosition, 160);
                    }
                    if (data.jeuneManque) {
                        yPosition = addWrappedText(doc, `Jours de jeûne à rattraper : ${data.jeuneManque}`, margin + 10, yPosition, 160);
                    }
                    if (data.priereManque) {
                        yPosition = addWrappedText(doc, `Prières manquées : ${data.priereManque}`, margin + 10, yPosition, 160);
                    }
                    if (data.sadaqa) {
                        yPosition = addWrappedText(doc, `Sadaqa et aumônes : ${data.sadaqa}`, margin + 10, yPosition, 160);
                    }
                }
                
                yPosition += 10;
                
                // Section 6: Legs et héritage
                yPosition = checkPageBreak(doc, yPosition, 20);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('6. LEGS ET HÉRITAGE', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                // Traitement des legs
                const legacies = [];
                Object.keys(data).forEach(key => {
                    if (key.startsWith('legs_') && key.endsWith('_beneficiaire') && data[key]) {
                        const baseId = key.replace('_beneficiaire', '');
                        legacies.push({
                            beneficiaire: data[baseId + '_beneficiaire'] || '',
                            objet: data[baseId + '_objet'] || '',
                            valeur: data[baseId + '_valeur'] || '',
                            conditions: data[baseId + '_conditions'] || ''
                        });
                    }
                });
                
                if (legacies.length > 0) {
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, 'Legs testamentaires (Wasiyya) :', margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    
                    legacies.forEach((legacy, index) => {
                        yPosition = addWrappedText(doc, `${index + 1}. Bénéficiaire : ${legacy.beneficiaire}`, margin + 10, yPosition, 160);
                        if (legacy.objet) {
                            yPosition = addWrappedText(doc, `   Objet : ${legacy.objet}`, margin + 10, yPosition, 160);
                        }
                        if (legacy.valeur) {
                            yPosition = addWrappedText(doc, `   Valeur : ${legacy.valeur} €`, margin + 10, yPosition, 160);
                        }
                        if (legacy.conditions) {
                            yPosition = addWrappedText(doc, `   Conditions : ${legacy.conditions}`, margin + 10, yPosition, 160);
                        }
                        yPosition += 5;
                    });
                }
                
                if (data.totalPatrimoine) {
                    yPosition = addWrappedText(doc, `Valeur totale du patrimoine : ${data.totalPatrimoine} €`, margin, yPosition, 170);
                }
                
                // Section 7: Comptes numériques
                yPosition = checkPageBreak(doc, yPosition, 20);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('7. COMPTES NUMÉRIQUES', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                // Traitement des comptes numériques
                const digitalTypes = ['reseauxSociaux', 'emails', 'comptesOnline'];
                const digitalLabels = {
                    'reseauxSociaux': 'Réseaux sociaux',
                    'emails': 'Comptes email',
                    'comptesOnline': 'Autres comptes en ligne'
                };
                
                digitalTypes.forEach(type => {
                    const accounts = [];
                    Object.keys(data).forEach(key => {
                        if (key.startsWith(type + '_') && key.endsWith('_service') && data[key]) {
                            const baseId = key.replace('_service', '');
                            accounts.push({
                                service: data[baseId + '_service'] || '',
                                username: data[baseId + '_username'] || '',
                                action: data[baseId + '_action'] || '',
                                contact: data[baseId + '_contact'] || ''
                            });
                        }
                    });
                    
                    if (accounts.length > 0) {
                        doc.setFont(undefined, 'bold');
                        yPosition = addWrappedText(doc, digitalLabels[type] + ':', margin, yPosition, 170);
                        doc.setFont(undefined, 'normal');
                        
                        accounts.forEach(account => {
                            yPosition = addWrappedText(doc, `- ${account.service}`, margin + 10, yPosition, 160);
                            if (account.username) {
                                yPosition = addWrappedText(doc, `  Utilisateur : ${account.username}`, margin + 10, yPosition, 160);
                            }
                            if (account.action) {
                                yPosition = addWrappedText(doc, `  Instruction : ${account.action}`, margin + 10, yPosition, 160);
                            }
                            if (account.contact) {
                                yPosition = addWrappedText(doc, `  Personne de confiance : ${account.contact}`, margin + 10, yPosition, 160);
                            }
                        });
                        yPosition += 5;
                    }
                });
                
                // Messages personnels
                if (data.messageFamille || data.conseilsEnfants || data.dernieresVolontes) {
                    yPosition = checkPageBreak(doc, yPosition, 20);
                    doc.setFont(undefined, 'bold');
                    yPosition = addWrappedText(doc, 'Messages personnels :', margin, yPosition, 170);
                    doc.setFont(undefined, 'normal');
                    
                    if (data.messageFamille) {
                        doc.setFont(undefined, 'bold');
                        yPosition = addWrappedText(doc, 'Message pour la famille :', margin + 10, yPosition, 160);
                        doc.setFont(undefined, 'normal');
                        yPosition = addWrappedText(doc, data.messageFamille, margin + 10, yPosition, 160);
                        yPosition += 5;
                    }
                    
                    if (data.conseilsEnfants) {
                        doc.setFont(undefined, 'bold');
                        yPosition = addWrappedText(doc, 'Conseils pour les enfants :', margin + 10, yPosition, 160);
                        doc.setFont(undefined, 'normal');
                        yPosition = addWrappedText(doc, data.conseilsEnfants, margin + 10, yPosition, 160);
                        yPosition += 5;
                    }
                    
                    if (data.dernieresVolontes) {
                        doc.setFont(undefined, 'bold');
                        yPosition = addWrappedText(doc, 'Dernières volontés :', margin + 10, yPosition, 160);
                        doc.setFont(undefined, 'normal');
                        yPosition = addWrappedText(doc, data.dernieresVolontes, margin + 10, yPosition, 160);
                    }
                }
                
                // Note finale
                yPosition = checkPageBreak(doc, yPosition, 30);
                yPosition += 20;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'italic');
                yPosition = addWrappedText(doc, 'Ce testament a été généré par Al Wassiya (الوصية). Pour être juridiquement valable, il doit être écrit, daté et signé de votre main selon les lois en vigueur dans votre pays de résidence.', margin, yPosition, 170);
                
                yPosition += 20;
                doc.setFont(undefined, 'normal');
                doc.text('Signature :', margin, yPosition);
                doc.text('Date :', margin + 100, yPosition);
                
                // Sauvegarder le PDF
                const fileName = `Testament_AlWassiya_${data.prenom || 'Document'}_${today.replace(/\//g, '-')}.pdf`;
                doc.save(fileName);
                
                // Afficher un message de succès
                alert('Testament PDF généré avec succès !');
                
            } catch (error) {
                console.error('Erreur lors de la génération du PDF:', error);
                alert('Une erreur est survenue lors de la génération du PDF. Veuillez réessayer.');
            }
        }

        // Initialisation au chargement de la page
        window.addEventListener('load', function() {
            // Auto-ouvrir certaines catégories par défaut
            toggleCategory('parents');
        });
    </script>
</body>
</html>
