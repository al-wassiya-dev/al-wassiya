<!DOCTYPE html>
<html lang="fr" dir="ltr" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-fr="Al Wassiya - Votre Testament Islamique Simplifié" data-ar="الوصية - وصيتك الإسلامية المبسطة">Al Wassiya - Votre Testament Islamique Simplifié</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/emailjs-com/3.2.0/email.min.js"></script>
    <style>
        :root {
            --primary: #C9B178;
            --primary-dark: #A89262;
            --secondary: #2D4C68;
            --accent: #3A5F7E;
            --light: #F8F5EE;
            --dark: #1E1E24;
            --success: #4CAF50;
            --error: #E74C3C;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Support pour l'arabe */
        [dir="rtl"] {
            font-family: 'Amiri', serif;
            text-align: right;
        }

        [dir="rtl"] .form-group label {
            text-align: right;
        }

        [dir="rtl"] .btn {
            margin-left: 0;
            margin-right: 10px;
        }

        /* Bouton de langue */
        .language-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--primary);
            border-radius: var(--radius);
            padding: 10px;
            box-shadow: var(--shadow);
        }

        .language-switcher button {
            background: transparent;
            border: none;
            color: white;
            font-weight: 600;
            padding: 5px 10px;
            margin: 0 2px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .language-switcher button.active,
        .language-switcher button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Style du header avec sous-titre arabe */
        .header-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .main-title {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .arabic-subtitle {
            font-family: 'Amiri', serif;
            font-size: 2rem;
            color: var(--secondary);
            margin-bottom: 1rem;
        }

        /* Styles pour les dropdowns */
        .family-dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--light);
            border-radius: var(--radius);
            font-size: 16px;
            background: white;
            transition: var(--transition);
        }

        .family-dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(201, 177, 120, 0.1);
        }

        /* Styles pour le PDF */
        .pdf-actions {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .pdf-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Footer styles */
        .footer {
            background: var(--secondary);
            color: white;
            padding: 3rem 0 1rem;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .footer-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
        }

        .footer-section p,
        .footer-section a {
            color: #ccc;
            text-decoration: none;
            margin-bottom: 0.5rem;
            display: block;
        }

        .footer-section a:hover {
            color: var(--primary);
        }

        .footer-bottom {
            border-top: 1px solid #444;
            margin-top: 2rem;
            padding-top: 1rem;
            text-align: center;
            color: #999;
        }

        /* Styles existants conservés */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--light) 0%, #fff 100%);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--dark);
        }

        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary);
            color: white;
            padding: 8px;
            border-radius: 4px;
            text-decoration: none;
            z-index: 1000;
            transition: top 0.3s;
        }

        .skip-to-content:focus {
            top: 6px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow);
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .form-step {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .form-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 3rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .step {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: #f5f5f5;
            border-radius: var(--radius);
            font-weight: 500;
            color: #666;
            transition: var(--transition);
            min-width: 120px;
            justify-content: center;
        }

        .step.active {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .step.completed {
            background: var(--success);
            color: white;
        }

        .step-number {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 12px;
            font-weight: 700;
        }

        h1 {
            text-align: center;
            color: var(--primary);
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        h2 {
            color: var(--secondary);
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .subtitle {
            text-align: center;
            color: var(--secondary);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .bismillah {
            text-align: center;
            font-size: 1.5rem;
            color: var(--primary);
            margin: 1.5rem 0;
            font-family: 'Amiri', serif;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--light);
            border-radius: var(--radius);
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(201, 177, 120, 0.1);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(201, 177, 120, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: var(--accent);
        }

        .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 3rem;
            gap: 1rem;
        }

        .btn-group .btn {
            flex: 1;
            max-width: 200px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .calculation-result {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--radius);
            margin: 1.5rem 0;
        }

        .calculation-result h3 {
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
        }

        .heritage-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .heritage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 12px;
        }

        .add-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            margin-top: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .add-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .dynamic-item {
            background: #f9f9f9;
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }

        .dynamic-item .remove-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            float: right;
            margin-top: -10px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--light);
            border-radius: 3px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .alert {
            padding: 1rem;
            border-radius: var(--radius);
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: var(--success);
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: var(--error);
        }

        @media (max-width: 768px) {
            .container {
                margin: 1rem;
                padding: 1.5rem;
                border-radius: 16px;
            }

            .two-column {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                max-width: none;
            }

            .step-indicator {
                gap: 0.5rem;
            }

            .step {
                min-width: 100px;
                padding: 8px 12px;
                font-size: 14px;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .pdf-actions {
                flex-direction: column;
                align-items: center;
            }

            .pdf-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Styles pour les éléments traduits */
        [data-translate] {
            transition: opacity 0.3s ease;
        }

        /* Animation pour les changements de langue */
        .lang-transition {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-content" data-fr="Aller au contenu principal" data-ar="انتقل إلى المحتوى الرئيسي">Aller au contenu principal</a>

    <!-- Sélecteur de langue -->
    <div class="language-switcher">
        <button onclick="switchLanguage('fr')" class="active" id="lang-fr">FR</button>
        <button onclick="switchLanguage('ar')" id="lang-ar">عر</button>
    </div>

    <div class="container" id="main-content">
        <!-- En-tête avec sous-titre arabe -->
        <div class="header-container">
            <h1 class="main-title" data-fr="Al Wassiya" data-ar="الوصية">Al Wassiya</h1>
            <div class="arabic-subtitle">الوصية</div>
            <div class="subtitle" data-fr="Votre Testament Islamique Simplifié" data-ar="وصيتك الإسلامية المبسطة">Votre Testament Islamique Simplifié</div>
            <div class="bismillah">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>
        </div>

        <!-- Barre de progression -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 14.3%;"></div>
        </div>

        <!-- Indicateur d'étapes -->
        <div class="step-indicator" id="stepIndicator">
            <div class="step active">
                <div class="step-number">1</div>
                <span data-fr="Identité" data-ar="الهوية">Identité</span>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <span data-fr="Famille" data-ar="العائلة">Famille</span>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <span data-fr="Patrimoine" data-ar="الثروة">Patrimoine</span>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <span data-fr="Dettes & Sadaqa" data-ar="الديون والصدقة">Dettes & Sadaqa</span>
            </div>
            <div class="step">
                <div class="step-number">5</div>
                <span data-fr="Héritage" data-ar="الميراث">Héritage</span>
            </div>
            <div class="step">
                <div class="step-number">6</div>
                <span data-fr="Digital" data-ar="الرقمي">Digital</span>
            </div>
            <div class="step">
                <div class="step-number">7</div>
                <span data-fr="Finalisation" data-ar="الإنهاء">Finalisation</span>
            </div>
        </div>
        <form id="testamentForm" novalidate>
            <!-- Étape 1: Informations personnelles -->
            <div class="form-step active" id="step1">
                <h2 data-fr="Informations personnelles" data-ar="المعلومات الشخصية">Informations personnelles</h2>
                
                <div class="two-column">
                    <div class="form-group">
                        <label for="nom" data-fr="Nom complet *" data-ar="الاسم الكامل *">Nom complet *</label>
                        <input type="text" id="nom" name="nom" required aria-describedby="nom-error">
                        <div class="error-message" id="nom-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="dateNaissance" data-fr="Date de naissance *" data-ar="تاريخ الميلاد *">Date de naissance *</label>
                        <input type="date" id="dateNaissance" name="dateNaissance" required>
                    </div>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="lieuNaissance" data-fr="Lieu de naissance" data-ar="مكان الميلاد">Lieu de naissance</label>
                        <input type="text" id="lieuNaissance" name="lieuNaissance">
                    </div>
                    
                    <div class="form-group">
                        <label for="nationalite" data-fr="Nationalité" data-ar="الجنسية">Nationalité</label>
                        <input type="text" id="nationalite" name="nationalite">
                    </div>
                </div>

                <div class="form-group">
                    <label for="adresse" data-fr="Adresse complète *" data-ar="العنوان الكامل *">Adresse complète *</label>
                    <textarea id="adresse" name="adresse" rows="3" required></textarea>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="sexe" data-fr="Sexe *" data-ar="الجنس *">Sexe *</label>
                        <select id="sexe" name="sexe" required>
                            <option value="" data-fr="Sélectionner..." data-ar="اختر...">Sélectionner...</option>
                            <option value="homme" data-fr="Homme" data-ar="رجل">Homme</option>
                            <option value="femme" data-fr="Femme" data-ar="امرأة">Femme</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="situationFamiliale" data-fr="Situation familiale *" data-ar="الحالة العائلية *">Situation familiale *</label>
                        <select id="situationFamiliale" name="situationFamiliale" required>
                            <option value="" data-fr="Sélectionner..." data-ar="اختر...">Sélectionner...</option>
                            <option value="celibataire" data-fr="Célibataire" data-ar="أعزب">Célibataire</option>
                            <option value="marie" data-fr="Marié(e)" data-ar="متزوج">Marié(e)</option>
                            <option value="divorce" data-fr="Divorcé(e)" data-ar="مطلق">Divorcé(e)</option>
                            <option value="veuf" data-fr="Veuf/Veuve" data-ar="أرمل">Veuf/Veuve</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Étape 2: Informations familiales avec menus déroulants -->
            <div class="form-step" id="step2">
                <h2 data-fr="Composition familiale" data-ar="تركيب العائلة">Composition familiale</h2>

                <!-- Parents avec menu déroulant -->
                <div class="form-group">
                    <label data-fr="Parents" data-ar="الوالدين">Parents</label>
                    <div id="parents-container">
                        <div class="dynamic-item">
                            <div class="two-column">
                                <div class="form-group">
                                    <label data-fr="Type de parent" data-ar="نوع الوالد">Type de parent</label>
                                    <select class="family-dropdown" name="parents[0][type]">
                                        <option value="" data-fr="Sélectionner..." data-ar="اختر...">Sélectionner...</option>
                                        <option value="pere" data-fr="Père" data-ar="الأب">Père</option>
                                        <option value="mere" data-fr="Mère" data-ar="الأم">Mère</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label data-fr="Nom" data-ar="الاسم">Nom</label>
                                    <input type="text" name="parents[0][nom]">
                                </div>
                            </div>
                            <div class="two-column">
                                <div class="form-group">
                                    <label data-fr="Vivant" data-ar="على قيد الحياة">Vivant</label>
                                    <select name="parents[0][vivant]">
                                        <option value="oui" data-fr="Oui" data-ar="نعم">Oui</option>
                                        <option value="non" data-fr="Non" data-ar="لا">Non</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label data-fr="Âge" data-ar="العمر">Âge</label>
                                    <input type="number" name="parents[0][age]" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-btn" onclick="addParent()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter un parent" data-ar="إضافة والد">Ajouter un parent</span>
                    </button>
                </div>

                <!-- Époux/Épouse avec menu déroulant -->
                <div class="form-group">
                    <label data-fr="Époux/Épouse" data-ar="الزوج/الزوجة">Époux/Épouse</label>
                    <div id="conjoint-container">
                        <div class="dynamic-item">
                            <div class="two-column">
                                <div class="form-group">
                                    <label data-fr="Type" data-ar="النوع">Type</label>
                                    <select class="family-dropdown" name="conjoint[0][type]">
                                        <option value="" data-fr="Sélectionner..." data-ar="اختر...">Sélectionner...</option>
                                        <option value="epoux" data-fr="Époux" data-ar="الزوج">Époux</option>
                                        <option value="epouse" data-fr="Épouse" data-ar="الزوجة">Épouse</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label data-fr="Nom" data-ar="الاسم">Nom</label>
                                    <input type="text" name="conjoint[0][nom]">
                                </div>
                            </div>
                            <div class="two-column">
                                <div class="form-group">
                                    <label data-fr="Date de mariage" data-ar="تاريخ الزواج">Date de mariage</label>
                                    <input type="date" name="conjoint[0][dateMarriage]">
                                </div>
                                <div class="form-group">
                                    <label data-fr="Âge" data-ar="العمر">Âge</label>
                                    <input type="number" name="conjoint[0][age]" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-btn" onclick="addConjoint()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter un conjoint" data-ar="إضافة زوج">Ajouter un conjoint</span>
                    </button>
                </div>

                <!-- Enfants avec menu déroulant fils/fille -->
                <div class="form-group">
                    <label data-fr="Enfants" data-ar="الأطفال">Enfants</label>
                    <div id="enfants-container">
                        <div class="dynamic-item">
                            <div class="two-column">
                                <div class="form-group">
                                    <label data-fr="Type" data-ar="النوع">Type</label>
                                    <select class="family-dropdown" name="enfants[0][type]">
                                        <option value="" data-fr="Sélectionner..." data-ar="اختر...">Sélectionner...</option>
                                        <option value="fils" data-fr="Fils" data-ar="ابن">Fils</option>
                                        <option value="fille" data-fr="Fille" data-ar="ابنة">Fille</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label data-fr="Nom" data-ar="الاسم">Nom</label>
                                    <input type="text" name="enfants[0][nom]">
                                </div>
                            </div>
                            <div class="two-column">
                                <div class="form-group">
                                    <label data-fr="Date de naissance" data-ar="تاريخ الميلاد">Date de naissance</label>
                                    <input type="date" name="enfants[0][dateNaissance]">
                                </div>
                                <div class="form-group">
                                    <label data-fr="Âge" data-ar="العمر">Âge</label>
                                    <input type="number" name="enfants[0][age]" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-btn" onclick="addEnfant()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter un enfant" data-ar="إضافة طفل">Ajouter un enfant</span>
                    </button>
                </div>

                <!-- Frères/Sœurs avec menu déroulant -->
                <div class="form-group">
                    <label data-fr="Frères et Sœurs" data-ar="الإخوة والأخوات">Frères et Sœurs</label>
                    <div id="fratrie-container">
                        <div class="dynamic-item">
                            <div class="two-column">
                                <div class="form-group">
                                    <label data-fr="Type" data-ar="النوع">Type</label>
                                    <select class="family-dropdown" name="fratrie[0][type]">
                                        <option value="" data-fr="Sélectionner..." data-ar="اختر...">Sélectionner...</option>
                                        <option value="frere" data-fr="Frère" data-ar="أخ">Frère</option>
                                        <option value="soeur" data-fr="Sœur" data-ar="أخت">Sœur</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label data-fr="Nom" data-ar="الاسم">Nom</label>
                                    <input type="text" name="fratrie[0][nom]">
                                </div>
                            </div>
                            <div class="two-column">
                                <div class="form-group">
                                    <label data-fr="Vivant" data-ar="على قيد الحياة">Vivant</label>
                                    <select name="fratrie[0][vivant]">
                                        <option value="oui" data-fr="Oui" data-ar="نعم">Oui</option>
                                        <option value="non" data-fr="Non" data-ar="لا">Non</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label data-fr="Âge" data-ar="العمر">Âge</label>
                                    <input type="number" name="fratrie[0][age]" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-btn" onclick="addFratrie()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter frère/sœur" data-ar="إضافة أخ/أخت">Ajouter frère/sœur</span>
                    </button>
                </div>

                <!-- Autres membres de la famille -->
                <div class="form-group">
                    <label data-fr="Autres membres de la famille" data-ar="أفراد آخرون من العائلة">Autres membres de la famille</label>
                    <div id="autres-famille-container"></div>
                    <button type="button" class="add-btn" onclick="addAutreFamille()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter autre membre" data-ar="إضافة عضو آخر">Ajouter autre membre</span>
                    </button>
                </div>
            </div>

            <!-- Étape 3: Patrimoine -->
            <div class="form-step" id="step3">
                <h2 data-fr="Évaluation du patrimoine" data-ar="تقييم الثروة">Évaluation du patrimoine</h2>
                
                <div class="form-group">
                    <label for="immobilier" data-fr="Biens immobiliers (€)" data-ar="العقارات (€)">Biens immobiliers (€)</label>
                    <input type="number" id="immobilier" name="immobilier" min="0" step="100" oninput="calculerPatrimoine()">
                </div>

                <div class="form-group">
                    <label for="comptes" data-fr="Comptes bancaires et épargne (€)" data-ar="الحسابات المصرفية والمدخرات (€)">Comptes bancaires et épargne (€)</label>
                    <input type="number" id="comptes" name="comptes" min="0" step="100" oninput="calculerPatrimoine()">
                </div>

                <div class="form-group">
                    <label for="vehicules" data-fr="Véhicules (€)" data-ar="المركبات (€)">Véhicules (€)</label>
                    <input type="number" id="vehicules" name="vehicules" min="0" step="100" oninput="calculerPatrimoine()">
                </div>

                <div class="form-group">
                    <label for="bijoux" data-fr="Bijoux et objets de valeur (€)" data-ar="المجوهرات والأشياء القيمة (€)">Bijoux et objets de valeur (€)</label>
                    <input type="number" id="bijoux" name="bijoux" min="0" step="100" oninput="calculerPatrimoine()">
                </div>

                <div class="form-group">
                    <label for="investissements" data-fr="Investissements et placements (€)" data-ar="الاستثمارات والودائع (€)">Investissements et placements (€)</label>
                    <input type="number" id="investissements" name="investissements" min="0" step="100" oninput="calculerPatrimoine()">
                </div>

                <div class="form-group">
                    <label for="autresBiens" data-fr="Autres biens (€)" data-ar="ممتلكات أخرى (€)">Autres biens (€)</label>
                    <input type="number" id="autresBiens" name="autresBiens" min="0" step="100" oninput="calculerPatrimoine()">
                </div>

                <div class="calculation-result">
                    <h3 data-fr="Patrimoine Total" data-ar="إجمالي الثروة">Patrimoine Total</h3>
                    <div id="patrimoineTotal">0 €</div>
                    <input type="hidden" id="totalPatrimoine" name="totalPatrimoine" value="0">
                </div>
            </div>

            <!-- Étape 4: Dettes et Sadaqa -->
            <div class="form-step" id="step4">
                <h2 data-fr="Dettes et Sadaqa" data-ar="الديون والصدقة">Dettes et Sadaqa</h2>

                <!-- Créances (argent à récupérer) -->
                <div class="form-group">
                    <label data-fr="Créances (argent à récupérer)" data-ar="المستحقات (المال المستحق)">Créances (argent à récupérer)</label>
                    <div id="creances-container"></div>
                    <button type="button" class="add-btn" onclick="addDebt('creances')">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter une créance" data-ar="إضافة مستحق">Ajouter une créance</span>
                    </button>
                </div>

                <!-- Dettes (argent à rembourser) -->
                <div class="form-group">
                    <label data-fr="Dettes (argent à rembourser)" data-ar="الديون (المال المطلوب سداده)">Dettes (argent à rembourser)</label>
                    <div id="dettes-container"></div>
                    <button type="button" class="add-btn" onclick="addDebt('dettes')">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter une dette" data-ar="إضافة دين">Ajouter une dette</span>
                    </button>
                </div>

                <!-- Sadaqa et dons -->
                <div class="form-group">
                    <label data-fr="Sadaqa et dons recommandés" data-ar="الصدقة والتبرعات الموصى بها">Sadaqa et dons recommandés</label>
                    <div id="sadaqa-container"></div>
                    <button type="button" class="add-btn" onclick="addSadaqa()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter une sadaqa" data-ar="إضافة صدقة">Ajouter une sadaqa</span>
                    </button>
                </div>

                <!-- Calcul de la Zakat -->
                <div class="form-group">
                    <h3 data-fr="Calcul de la Zakat" data-ar="حساب الزكاة">Calcul de la Zakat</h3>
                    
                    <div class="two-column">
                        <div class="form-group">
                            <label for="nissab" data-fr="Nissab (seuil minimum)" data-ar="النصاب (الحد الأدنى)">Nissab (seuil minimum)</label>
                            <input type="number" id="nissab" name="nissab" value="4914" step="0.01" oninput="calculerZakat()">
                        </div>
                        
                        <div class="form-group">
                            <label for="epargne" data-fr="Épargne et liquidités" data-ar="المدخرات والسيولة">Épargne et liquidités</label>
                            <input type="number" id="epargne" name="epargne" min="0" step="0.01" oninput="calculerZakat()">
                        </div>
                    </div>

                    <div class="two-column">
                        <div class="form-group">
                            <label for="autres_actifs" data-fr="Autres actifs zakatable" data-ar="أصول أخرى خاضعة للزكاة">Autres actifs zakatable</label>
                            <input type="number" id="autres_actifs" name="autres_actifs" min="0" step="0.01" oninput="calculerZakat()">
                        </div>
                        
                        <div class="form-group">
                            <label for="dettes_zakat" data-fr="Dettes à déduire" data-ar="الديون المطلوب خصمها">Dettes à déduire</label>
                            <input type="number" id="dettes_zakat" name="dettes_zakat" min="0" step="0.01" oninput="calculerZakat()">
                        </div>
                    </div>

                    <div class="calculation-result" id="zakatResult">
                        <h3 data-fr="Résultat du calcul de la Zakat" data-ar="نتيجة حساب الزكاة">Résultat du calcul de la Zakat</h3>
                        <div id="zakatAmount">0 €</div>
                        <div id="zakatStatus" data-fr="Calcul en attente..." data-ar="الحساب في الانتظار...">Calcul en attente...</div>
                    </div>
                </div>
            </div>

            <!-- Étape 5: Calcul de l'héritage -->
            <div class="form-step" id="step5">
                <h2 data-fr="Répartition de l'héritage selon la Charia" data-ar="توزيع الميراث حسب الشريعة">Répartition de l'héritage selon la Charia</h2>
                
                <div class="form-group">
                    <h3 data-fr="Legs (maximum 1/3 du patrimoine)" data-ar="الوصايا (حد أقصى ثلث الثروة)">Legs (maximum 1/3 du patrimoine)</h3>
                    <div id="legsContainer"></div>
                    <button type="button" class="add-btn" onclick="addLeg()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter un legs" data-ar="إضافة وصية">Ajouter un legs</span>
                    </button>
                    
                    <div id="legsSummary" class="calculation-result">
                        <div data-fr="Total des legs: 0 €" data-ar="مجموع الوصايا: 0 €">Total des legs: 0 €</div>
                        <div data-fr="Patrimoine disponible: 0 €" data-ar="الثروة المتاحة: 0 €">Patrimoine disponible: 0 €</div>
                    </div>
                </div>

                <div class="form-group">
                    <button type="button" class="btn" onclick="calculerHeritage()">
                        <i class="fas fa-calculator"></i>
                        <span data-fr="Calculer la répartition" data-ar="احسب التوزيع">Calculer la répartition</span>
                    </button>
                </div>

                <div id="heritageGrid" class="heritage-grid"></div>
            </div>

            <!-- Étape 6: Patrimoine numérique -->
            <div class="form-step" id="step6">
                <h2 data-fr="Patrimoine numérique" data-ar="الثروة الرقمية">Patrimoine numérique</h2>

                <!-- Réseaux sociaux -->
                <div class="form-group">
                    <label data-fr="Réseaux sociaux" data-ar="الشبكات الاجتماعية">Réseaux sociaux</label>
                    <div id="reseaux-sociaux-container"></div>
                    <button type="button" class="add-btn" onclick="addReseauSocial()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter un réseau social" data-ar="إضافة شبكة اجتماعية">Ajouter un réseau social</span>
                    </button>
                </div>

                <!-- Comptes email -->
                <div class="form-group">
                    <label data-fr="Comptes email" data-ar="حسابات البريد الإلكتروني">Comptes email</label>
                    <div id="emails-container"></div>
                    <button type="button" class="add-btn" onclick="addEmail()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter un email" data-ar="إضافة بريد إلكتروني">Ajouter un email</span>
                    </button>
                </div>

                <!-- Comptes en ligne -->
                <div class="form-group">
                    <label data-fr="Comptes en ligne" data-ar="الحسابات الرقمية">Comptes en ligne</label>
                    <div id="comptes-online-container"></div>
                    <button type="button" class="add-btn" onclick="addCompteOnline()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter un compte" data-ar="إضافة حساب">Ajouter un compte</span>
                    </button>
                </div>

                <!-- Services cloud -->
                <div class="form-group">
                    <label data-fr="Services cloud" data-ar="خدمات التخزين السحابي">Services cloud</label>
                    <div id="cloud-container"></div>
                    <button type="button" class="add-btn" onclick="addCloud()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter un service cloud" data-ar="إضافة خدمة سحابية">Ajouter un service cloud</span>
                    </button>
                </div>

                <!-- Appareils -->
                <div class="form-group">
                    <label data-fr="Appareils numériques" data-ar="الأجهزة الرقمية">Appareils numériques</label>
                    <div id="appareils-container"></div>
                    <button type="button" class="add-btn" onclick="addAppareil()">
                        <i class="fas fa-plus"></i>
                        <span data-fr="Ajouter un appareil" data-ar="إضافة جهاز">Ajouter un appareil</span>
                    </button>
                </div>
            </div>

            <!-- Étape 7: Finalisation -->
            <div class="form-step" id="step7">
                <h2 data-fr="Finalisation du testament" data-ar="إنهاء الوصية">Finalisation du testament</h2>

                <div class="form-group">
                    <label for="dernieresVolontes" data-fr="Dernières volontés et instructions particulières" data-ar="الأمنيات الأخيرة والتعليمات الخاصة">Dernières volontés et instructions particulières</label>
                    <textarea id="dernieresVolontes" name="dernieresVolontes" rows="6" placeholder="Précisez ici vos dernières volontés, souhaits particuliers concernant les funérailles, messages à transmettre, etc."></textarea>
                </div>

                <div class="form-group">
                    <label for="executeurTestamentaire" data-fr="Exécuteur testamentaire" data-ar="منفذ الوصية">Exécuteur testamentaire</label>
                    <input type="text" id="executeurTestamentaire" name="executeurTestamentaire" placeholder="Nom de la personne de confiance">
                </div>

                <div class="form-group">
                    <label for="dateRedaction" data-fr="Date de rédaction" data-ar="تاريخ التحرير">Date de rédaction</label>
                    <input type="date" id="dateRedaction" name="dateRedaction">
                </div>

                <div class="form-group">
                    <label for="lieuRedaction" data-fr="Lieu de rédaction" data-ar="مكان التحرير">Lieu de rédaction</label>
                    <input type="text" id="lieuRedaction" name="lieuRedaction">
                </div>

                <!-- Actions PDF -->
                <div class="pdf-actions">
                    <button type="button" class="pdf-btn" onclick="genererPDF()">
                        <i class="fas fa-file-pdf"></i>
                        <span data-fr="Télécharger PDF" data-ar="تحميل PDF">Télécharger PDF</span>
                    </button>
                    <button type="button" class="pdf-btn" onclick="envoyerParEmail()">
                        <i class="fas fa-envelope"></i>
                        <span data-fr="Envoyer par Email" data-ar="إرسال بالبريد الإلكتروني">Envoyer par Email</span>
                    </button>
                    <button type="button" class="pdf-btn" onclick="sauvegarderBrouillon()">
                        <i class="fas fa-save"></i>
                        <span data-fr="Sauvegarder" data-ar="حفظ">Sauvegarder</span>
                    </button>
                </div>
            </div>

            <!-- Boutons de navigation -->
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display: none;">
                    <i class="fas fa-arrow-left"></i>
                    <span data-fr="Précédent" data-ar="السابق">Précédent</span>
                </button>
                <button type="button" class="btn" id="nextBtn" onclick="nextStep()">
                    <span data-fr="Suivant" data-ar="التالي">Suivant</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </form>
    </div>
        <script>
        // Variables globales
        let currentStep = 1;
        const totalSteps = 7;
        let currentLanguage = 'fr';

        // Traductions
        const translations = {
            fr: {
                // Navigation
                'precedent': 'Précédent',
                'suivant': 'Suivant',
                'finaliser': 'Finaliser',
                
                // Étapes
                'identite': 'Identité',
                'famille': 'Famille',
                'patrimoine': 'Patrimoine',
                'dettes_sadaqa': 'Dettes & Sadaqa',
                'heritage': 'Héritage',
                'digital': 'Digital',
                'finalisation': 'Finalisation',
                
                // Messages
                'champ_requis': 'Ce champ est requis',
                'email_invalide': 'Email invalide',
                'pdf_genere': 'PDF généré avec succès',
                'email_envoye': 'Email envoyé avec succès',
                'erreur': 'Une erreur est survenue',
                'sauvegarde': 'Sauvegardé avec succès',
                
                // PDF
                'testament_islamique': 'TESTAMENT ISLAMIQUE (WASSIYA)',
                'date_redaction': 'Date de rédaction',
                'informations_personnelles': 'INFORMATIONS PERSONNELLES',
                'composition_familiale': 'COMPOSITION FAMILIALE',
                'evaluation_patrimoine': 'ÉVALUATION DU PATRIMOINE',
                'dettes_creances': 'DETTES ET CRÉANCES',
                'repartition_heritage': 'RÉPARTITION DE L\'HÉRITAGE',
                'patrimoine_numerique': 'PATRIMOINE NUMÉRIQUE',
                'dernieres_volontes': 'DERNIÈRES VOLONTÉS'
            },
            ar: {
                // Navigation
                'precedent': 'السابق',
                'suivant': 'التالي',
                'finaliser': 'إنهاء',
                
                // Étapes
                'identite': 'الهوية',
                'famille': 'العائلة',
                'patrimoine': 'الثروة',
                'dettes_sadaqa': 'الديون والصدقة',
                'heritage': 'الميراث',
                'digital': 'الرقمي',
                'finalisation': 'الإنهاء',
                
                // Messages
                'champ_requis': 'هذا الحقل مطلوب',
                'email_invalide': 'بريد إلكتروني غير صحيح',
                'pdf_genere': 'تم إنشاء PDF بنجاح',
                'email_envoye': 'تم إرسال البريد الإلكتروني بنجاح',
                'erreur': 'حدث خطأ',
                'sauvegarde': 'تم الحفظ بنجاح',
                
                // PDF
                'testament_islamique': 'الوصية الإسلامية',
                'date_redaction': 'تاريخ التحرير',
                'informations_personnelles': 'المعلومات الشخصية',
                'composition_familiale': 'تركيب العائلة',
                'evaluation_patrimoine': 'تقييم الثروة',
                'dettes_creances': 'الديون والمستحقات',
                'repartition_heritage': 'توزيع الميراث',
                'patrimoine_numerique': 'الثروة الرقمية',
                'dernieres_volontes': 'الأمنيات الأخيرة'
            }
        };

        // Fonction de changement de langue
        function switchLanguage(lang) {
            currentLanguage = lang;
            const htmlRoot = document.getElementById('html-root');
            
            // Changer la direction du texte
            if (lang === 'ar') {
                htmlRoot.setAttribute('dir', 'rtl');
                htmlRoot.setAttribute('lang', 'ar');
            } else {
                htmlRoot.setAttribute('dir', 'ltr');
                htmlRoot.setAttribute('lang', 'fr');
            }
            
            // Mettre à jour les boutons de langue
            document.getElementById('lang-fr').classList.toggle('active', lang === 'fr');
            document.getElementById('lang-ar').classList.toggle('active', lang === 'ar');
            
            // Traduire tous les éléments
            const elementsToTranslate = document.querySelectorAll('[data-fr]');
            elementsToTranslate.forEach(element => {
                const frText = element.getAttribute('data-fr');
                const arText = element.getAttribute('data-ar');
                
                if (lang === 'ar' && arText) {
                    element.textContent = arText;
                } else if (lang === 'fr' && frText) {
                    element.textContent = frText;
                }
            });
            
            // Mettre à jour les placeholders
            const elementsWithPlaceholder = document.querySelectorAll('[data-placeholder-fr]');
            elementsWithPlaceholder.forEach(element => {
                const frPlaceholder = element.getAttribute('data-placeholder-fr');
                const arPlaceholder = element.getAttribute('data-placeholder-ar');
                
                if (lang === 'ar' && arPlaceholder) {
                    element.placeholder = arPlaceholder;
                } else if (lang === 'fr' && frPlaceholder) {
                    element.placeholder = frPlaceholder;
                }
            });
            
            // Mettre à jour les options des select
            const selectElements = document.querySelectorAll('select option[data-fr]');
            selectElements.forEach(option => {
                const frText = option.getAttribute('data-fr');
                const arText = option.getAttribute('data-ar');
                
                if (lang === 'ar' && arText) {
                    option.textContent = arText;
                } else if (lang === 'fr' && frText) {
                    option.textContent = frText;
                }
            });
        }

        // Fonction pour obtenir une traduction
        function getTranslation(key) {
            return translations[currentLanguage][key] || key;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Définir la date actuelle
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateRedaction').value = today;
            
            // Initialiser EmailJS (vous devez remplacer par vos clés)
            // emailjs.init("YOUR_PUBLIC_KEY");
            
            updateStepIndicator();
            updateProgressBar();
        });

        // Navigation entre étapes
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    document.getElementById(`step${currentStep}`).classList.remove('active');
                    currentStep++;
                    document.getElementById(`step${currentStep}`).classList.add('active');
                    updateStepIndicator();
                    updateProgressBar();
                    updateNavigationButtons();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateStepIndicator();
                updateProgressBar();
                updateNavigationButtons();
            }
        }

        function updateStepIndicator() {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    step.classList.add('active');
                } else if (index + 1 < currentStep) {
                    step.classList.add('completed');
                }
            });
        }

        function updateProgressBar() {
            const progressPercentage = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progressPercentage + '%';
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.style.display = currentStep === 1 ? 'none' : 'inline-flex';
            
            if (currentStep === totalSteps) {
                nextBtn.innerHTML = `<span data-fr="Finaliser" data-ar="إنهاء">${getTranslation('finaliser')}</span><i class="fas fa-check"></i>`;
            } else {
                nextBtn.innerHTML = `<span data-fr="Suivant" data-ar="التالي">${getTranslation('suivant')}</span><i class="fas fa-arrow-right"></i>`;
            }
        }

        // Validation des étapes
        function validateCurrentStep() {
            const currentStepElement = document.getElementById(`step${currentStep}`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('error');
                    isValid = false;
                } else {
                    field.classList.remove('error');
                }
            });

            return isValid;
        }

        // Calculs patrimoine
        function calculerPatrimoine() {
            const immobilier = parseFloat(document.getElementById('immobilier').value) || 0;
            const comptes = parseFloat(document.getElementById('comptes').value) || 0;
            const vehicules = parseFloat(document.getElementById('vehicules').value) || 0;
            const bijoux = parseFloat(document.getElementById('bijoux').value) || 0;
            const investissements = parseFloat(document.getElementById('investissements').value) || 0;
            const autresBiens = parseFloat(document.getElementById('autresBiens').value) || 0;

            const total = immobilier + comptes + vehicules + bijoux + investissements + autresBiens;
            
            document.getElementById('patrimoineTotal').textContent = total.toLocaleString('fr-FR') + ' €';
            document.getElementById('totalPatrimoine').value = total;
        }

        // Fonction pour ajouter un parent
        function addParent() {
            const container = document.getElementById('parents-container');
            const index = container.children.length;

            const parentDiv = document.createElement('div');
            parentDiv.className = 'dynamic-item';
            parentDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Type de parent" data-ar="نوع الوالد">Type de parent</label>
                        <select class="family-dropdown" name="parents[${index}][type]">
                            <option value="" data-fr="Sélectionner..." data-ar="اختر...">Sélectionner...</option>
                            <option value="pere" data-fr="Père" data-ar="الأب">Père</option>
                            <option value="mere" data-fr="Mère" data-ar="الأم">Mère</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-fr="Nom" data-ar="الاسم">Nom</label>
                        <input type="text" name="parents[${index}][nom]">
                    </div>
                </div>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Vivant" data-ar="على قيد الحياة">Vivant</label>
                        <select name="parents[${index}][vivant]">
                            <option value="oui" data-fr="Oui" data-ar="نعم">Oui</option>
                            <option value="non" data-fr="Non" data-ar="لا">Non</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-fr="Âge" data-ar="العمر">Âge</label>
                        <input type="number" name="parents[${index}][age]" min="0">
                    </div>
                </div>
            `;
            
            container.appendChild(parentDiv);
            
            // Traduire les nouveaux éléments
            switchLanguage(currentLanguage);
        }

        // Fonction pour ajouter un conjoint
        function addConjoint() {
            const container = document.getElementById('conjoint-container');
            const index = container.children.length;

            const conjointDiv = document.createElement('div');
            conjointDiv.className = 'dynamic-item';
            conjointDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Type" data-ar="النوع">Type</label>
                        <select class="family-dropdown" name="conjoint[${index}][type]">
                            <option value="" data-fr="Sélectionner..." data-ar="اختر...">Sélectionner...</option>
                            <option value="epoux" data-fr="Époux" data-ar="الزوج">Époux</option>
                            <option value="epouse" data-fr="Épouse" data-ar="الزوجة">Épouse</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-fr="Nom" data-ar="الاسم">Nom</label>
                        <input type="text" name="conjoint[${index}][nom]">
                    </div>
                </div>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Date de mariage" data-ar="تاريخ الزواج">Date de mariage</label>
                        <input type="date" name="conjoint[${index}][dateMarriage]">
                    </div>
                    <div class="form-group">
                        <label data-fr="Âge" data-ar="العمر">Âge</label>
                        <input type="number" name="conjoint[${index}][age]" min="0">
                    </div>
                </div>
            `;
            
            container.appendChild(conjointDiv);
            switchLanguage(currentLanguage);
        }

        // Fonction pour ajouter un enfant
        function addEnfant() {
            const container = document.getElementById('enfants-container');
            const index = container.children.length;

            const enfantDiv = document.createElement('div');
            enfantDiv.className = 'dynamic-item';
            enfantDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Type" data-ar="النوع">Type</label>
                        <select class="family-dropdown" name="enfants[${index}][type]">
                            <option value="" data-fr="Sélectionner..." data-ar="اختر...">Sélectionner...</option>
                            <option value="fils" data-fr="Fils" data-ar="ابن">Fils</option>
                            <option value="fille" data-fr="Fille" data-ar="ابنة">Fille</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-fr="Nom" data-ar="الاسم">Nom</label>
                        <input type="text" name="enfants[${index}][nom]">
                    </div>
                </div>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Date de naissance" data-ar="تاريخ الميلاد">Date de naissance</label>
                        <input type="date" name="enfants[${index}][dateNaissance]">
                    </div>
                    <div class="form-group">
                        <label data-fr="Âge" data-ar="العمر">Âge</label>
                        <input type="number" name="enfants[${index}][age]" min="0">
                    </div>
                </div>
            `;
            
            container.appendChild(enfantDiv);
            switchLanguage(currentLanguage);
        }

        // Fonction pour ajouter un frère/sœur
        function addFratrie() {
            const container = document.getElementById('fratrie-container');
            const index = container.children.length;

            const fratrieDiv = document.createElement('div');
            fratrieDiv.className = 'dynamic-item';
            fratrieDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Type" data-ar="النوع">Type</label>
                        <select class="family-dropdown" name="fratrie[${index}][type]">
                            <option value="" data-fr="Sélectionner..." data-ar="اختر...">Sélectionner...</option>
                            <option value="frere" data-fr="Frère" data-ar="أخ">Frère</option>
                            <option value="soeur" data-fr="Sœur" data-ar="أخت">Sœur</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-fr="Nom" data-ar="الاسم">Nom</label>
                        <input type="text" name="fratrie[${index}][nom]">
                    </div>
                </div>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Vivant" data-ar="على قيد الحياة">Vivant</label>
                        <select name="fratrie[${index}][vivant]">
                            <option value="oui" data-fr="Oui" data-ar="نعم">Oui</option>
                            <option value="non" data-fr="Non" data-ar="لا">Non</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-fr="Âge" data-ar="العمر">Âge</label>
                        <input type="number" name="fratrie[${index}][age]" min="0">
                    </div>
                </div>
            `;
            
            container.appendChild(fratrieDiv);
            switchLanguage(currentLanguage);
        }

        // Fonction pour ajouter autre membre famille
        function addAutreFamille() {
            const container = document.getElementById('autres-famille-container');
            const index = container.children.length;

            const autreDiv = document.createElement('div');
            autreDiv.className = 'dynamic-item';
            autreDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Relation" data-ar="القرابة">Relation</label>
                        <input type="text" name="autresFamille[${index}][relation]" placeholder="Grand-parent, oncle, etc.">
                    </div>
                    <div class="form-group">
                        <label data-fr="Nom" data-ar="الاسم">Nom</label>
                        <input type="text" name="autresFamille[${index}][nom]">
                    </div>
                </div>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Vivant" data-ar="على قيد الحياة">Vivant</label>
                        <select name="autresFamille[${index}][vivant]">
                            <option value="oui" data-fr="Oui" data-ar="نعم">Oui</option>
                            <option value="non" data-fr="Non" data-ar="لا">Non</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-fr="Âge" data-ar="العمر">Âge</label>
                        <input type="number" name="autresFamille[${index}][age]" min="0">
                    </div>
                </div>
            `;
            
            container.appendChild(autreDiv);
            switchLanguage(currentLanguage);
        }

        // Fonction pour ajouter une créance ou dette
        function addDebt(category) {
            const container = document.getElementById(`${category}-container`);
            const index = container.children.length;

            const debtDiv = document.createElement('div');
            debtDiv.className = 'dynamic-item';
            debtDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Description" data-ar="الوصف">Description</label>
                        <input type="text" name="${category}[${index}][description]">
                    </div>
                    <div class="form-group">
                        <label data-fr="Montant (€)" data-ar="المبلغ (€)">Montant (€)</label>
                        <input type="number" name="${category}[${index}][montant]" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label data-fr="Personne concernée" data-ar="الشخص المعني">Personne concernée</label>
                    <input type="text" name="${category}[${index}][personne]">
                </div>
            `;
            
            container.appendChild(debtDiv);
            switchLanguage(currentLanguage);
        }

        // Fonction pour ajouter une sadaqa
        function addSadaqa() {
            const container = document.getElementById('sadaqa-container');
            const index = container.children.length;

            const sadaqaDiv = document.createElement('div');
            sadaqaDiv.className = 'dynamic-item';
            sadaqaDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Type de sadaqa" data-ar="نوع الصدقة">Type de sadaqa</label>
                        <select name="sadaqa[${index}][type]">
                            <option value="mosquee" data-fr="Mosquée" data-ar="المسجد">Mosquée</option>
                            <option value="orphelinat" data-fr="Orphelinat" data-ar="دار الأيتام">Orphelinat</option>
                            <option value="pauvres" data-fr="Aide aux pauvres" data-ar="مساعدة الفقراء">Aide aux pauvres</option>
                            <option value="education" data-fr="Éducation islamique" data-ar="التعليم الإسلامي">Éducation islamique</option>
                            <option value="autre" data-fr="Autre" data-ar="أخرى">Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-fr="Montant ou pourcentage" data-ar="المبلغ أو النسبة">Montant ou pourcentage</label>
                        <input type="text" name="sadaqa[${index}][montant]" placeholder="1000€ ou 5%">
                    </div>
                </div>
                <div class="form-group">
                    <label data-fr="Bénéficiaire" data-ar="المستفيد">Bénéficiaire</label>
                    <input type="text" name="sadaqa[${index}][beneficiaire]">
                </div>
            `;
            
            container.appendChild(sadaqaDiv);
            switchLanguage(currentLanguage);
        }

        // Fonction pour ajouter un legs
        function addLeg() {
            const container = document.getElementById('legsContainer');
            const index = container.children.length;

            const legDiv = document.createElement('div');
            legDiv.className = 'dynamic-item';
            legDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.parentElement.remove(); updateLegsSummary();">×</button>
                <div class="two-column">
                    <div class="form-group">
                        <label data-fr="Bénéficiaire" data-ar="المستفيد">Bénéficiaire</label>
                        <input type="text" name="legs[${index}][beneficiaire]">
                    </div>
                    <div class="form-group">
                        <label data-fr="Valeur (€)" data-ar="القيمة (€)">Valeur (€)</label>
                        <input type="number" name="legs[${index}][valeur]" min="0" step="0.01" oninput="updateLegsSummary()">
                    </div>
                </div>
                <div class="form-group">
                    <label data-fr="Description" data-ar="الوصف">Description</label>
                    <textarea name="legs[${index}][description]" rows="2"></textarea>
                </div>
            `;
            
            container.appendChild(legDiv);
            switchLanguage(currentLanguage);
            updateLegsSummary();
        }

        // Fonction pour mettre à jour le résumé des legs
        function updateLegsSummary() {
            const totalPatrimoine = parseFloat(document.getElementById('totalPatrimoine').value) || 0;
            const legs = document.querySelectorAll('[name^="legs["][name$="][valeur]"]');
            let totalLegs = 0;

            legs.forEach(leg => {
                totalLegs += parseFloat(leg.value) || 0;
            });

            const maxLegs = totalPatrimoine / 3;
            const patrimoineDisponible = totalPatrimoine - totalLegs;

            const summary = document.getElementById('legsSummary');
            summary.innerHTML = `
                <div>Total des legs: ${totalLegs.toLocaleString('fr-FR')} €</div>
                <div>Maximum autorisé (1/3): ${maxLegs.toLocaleString('fr-FR')} €</div>
                <div>Patrimoine disponible: ${patrimoineDisponible.toLocaleString('fr-FR')} €</div>
                ${totalLegs > maxLegs ? '<div style="color: #E74C3C;">⚠️ Les legs dépassent le maximum autorisé !</div>' : ''}
            `;
        }

        // Fonction pour calculer l'héritage selon les règles islamiques (CORRIGÉE)
        function calculerHeritage() {
            const sexe = document.getElementById('sexe').value;
            const situationFamiliale = document.getElementById('situationFamiliale').value;
            const totalPatrimoine = parseFloat(document.getElementById('totalPatrimoine').value) || 0;
            const heritageGrid = document.getElementById('heritageGrid');

            // Récolter les données familiales
            const parents = collectFamilyData('parents');
            const conjoint = collectFamilyData('conjoint');
            const enfants = collectFamilyData('enfants');
            const fratrie = collectFamilyData('fratrie');

            // Calculer les parts selon la Charia
            const heritage = calculateIslamicInheritance(sexe, situationFamiliale, parents, conjoint, enfants, fratrie, totalPatrimoine);

            // Afficher les résultats
            heritageGrid.innerHTML = '';
            if (heritage && heritage.length > 0) {
                heritage.forEach(heir => {
                    const heirDiv = document.createElement('div');
                    heirDiv.className = 'heritage-item';
                    heirDiv.innerHTML = `
                        <span><strong>${heir.nom}</strong> (${heir.relation})</span>
                        <span>${heir.montant.toLocaleString('fr-FR')} € (${heir.pourcentage}%)</span>
                    `;
                    heritageGrid.appendChild(heirDiv);
                });
            } else {
                heritageGrid.innerHTML = `<div class="heritage-item"><span>Aucun héritier identifié ou données insuffisantes</span></div>`;
            }
        }

        // Fonction pour collecter les données familiales
        function collectFamilyData(category) {
            const data = [];
            const inputs = document.querySelectorAll(`[name^="${category}["]`);
            const grouped = {};

            inputs.forEach(input => {
                const match = input.name.match(new RegExp(`${category}\\[(\\d+)\\]\\[(.+)\\]`));
                if (match) {
                    const index = match[1];
                    const field = match[2];
                    
                    if (!grouped[index]) grouped[index] = {};
                    grouped[index][field] = input.value;
                }
            });

            Object.values(grouped).forEach(member => {
                if (member.nom || member.type) {
                    data.push(member);
                }
            });

            return data;
        }

        // Calcul de l'héritage islamique (version simplifiée)
        function calculateIslamicInheritance(sexe, situation, parents, conjoint, enfants, fratrie, patrimoine) {
            const heritiers = [];
            let totalParts = 0;

            // Conjoint
            if (conjoint && conjoint.length > 0) {
                const conjointPart = enfants.length > 0 ? 0.125 : 0.25; // 1/8 si enfants, 1/4 sinon
                heritiers.push({
                    nom: conjoint[0].nom || 'Conjoint(e)',
                    relation: conjoint[0].type || 'Conjoint(e)',
                    pourcentage: (conjointPart * 100).toFixed(1),
                    montant: patrimoine * conjointPart
                });
                totalParts += conjointPart;
            }

            // Parents
            parents.forEach(parent => {
                if (parent.vivant === 'oui') {
                    const parentPart = enfants.length > 0 ? 0.167 : 0.333; // 1/6 si enfants, 1/3 sinon
                    heritiers.push({
                        nom: parent.nom || parent.type,
                        relation: parent.type === 'pere' ? 'Père' : 'Mère',
                        pourcentage: (parentPart * 100).toFixed(1),
                        montant: patrimoine * parentPart
                    });
                    totalParts += parentPart;
                }
            });

            // Enfants
            if (enfants.length > 0) {
                const resteApresConjoitParents = 1 - totalParts;
                const filsCount = enfants.filter(e => e.type === 'fils').length;
                const filleCount = enfants.filter(e => e.type === 'fille').length;
                
                // En Islam, un fils hérite deux fois plus qu'une fille
                const totalShares = (filsCount * 2) + filleCount;
                
                enfants.forEach(enfant => {
                    const shares = enfant.type === 'fils' ? 2 : 1;
                    const enfantPart = (shares / totalShares) * resteApresConjoitParents;
                    
                    heritiers.push({
                        nom: enfant.nom || enfant.type,
                        relation: enfant.type === 'fils' ? 'Fils' : 'Fille',
                        pourcentage: (enfantPart * 100).toFixed(1),
                        montant: patrimoine * enfantPart
                    });
                });
                totalParts = 1; // Les enfants prennent le reste
            }

            // Si pas d'enfants, la fratrie peut hériter
            if (enfants.length === 0 && fratrie.length > 0) {
                const restePourFratrie = 1 - totalParts;
                if (restePourFratrie > 0) {
                    const frereCount = fratrie.filter(f => f.type === 'frere' && f.vivant === 'oui').length;
                    const soeurCount = fratrie.filter(f => f.type === 'soeur' && f.vivant === 'oui').length;
                    const totalSharesFratrie = (frereCount * 2) + soeurCount;
                    
                    if (totalSharesFratrie > 0) {
                        fratrie.forEach(membre => {
                            if (membre.vivant === 'oui') {
                                const shares = membre.type === 'frere' ? 2 : 1;
                                const membrePart = (shares / totalSharesFratrie) * restePourFratrie;
                                
                                heritiers.push({
                                    nom: membre.nom || membre.type,
                                    relation: membre.type === 'frere' ? 'Frère' : 'Sœur',
                                    pourcentage: (membrePart * 100).toFixed(1),
                                    montant: patrimoine * membrePart
                                });
                            }
                        });
                    }
                }
            }

            return heritiers;
        }

        // Fonction pour calculer la Zakat (CORRIGÉE)
        function calculerZakat() {
            const nissab = parseFloat(document.getElementById('nissab').value) || 0;
            const epargne = parseFloat(document.getElementById('epargne').value) || 0;
            const autresActifs = parseFloat(document.getElementById('autres_actifs').value) || 0;
            const dettes = parseFloat(document.getElementById('dettes_zakat').value) || 0;

            const totalActifs = epargne + autresActifs - dettes;
            const zakatAmount = totalActifs >= nissab ? totalActifs * 0.025 : 0;

            document.getElementById('zakatAmount').textContent = zakatAmount.toLocaleString('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            });

            const statusElement = document.getElementById('zakatStatus');
            if (totalActifs >= nissab) {
                statusElement.textContent = getTranslation('zakat_due');
                statusElement.style.color = '#4CAF50';
            } else {
                statusElement.textContent = getTranslation('zakat_not_due');
                statusElement.style.color = '#FF9800';
            }
        }
// Générer le PDF du testament
async function genererPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');
    const pdfTitle = currentLanguage === 'ar' ? 'الوصية الإسلامية' : 'TESTAMENT ISLAMIQUE (WASSIYA)';
    const dateRedaction = document.getElementById('dateRedaction').value;
    
    // Ajouter le titre
    doc.setFont('Playfair Display', 'bold');
    doc.setFontSize(24);
    if (currentLanguage === 'ar') {
        doc.setFont('Amiri', 'bold');
        doc.text(pdfTitle, 300, 40, { align: 'center', rtl: true });
        doc.setFontSize(14);
        doc.text('بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ', 300, 65, { align: 'center', rtl: true });
    } else {
        doc.text(pdfTitle, 300, 40, { align: 'center' });
        doc.setFontSize(14);
        doc.text('Bismillah ir-Rahman ir-Rahim', 300, 65, { align: 'center' });
    }

    doc.setDrawColor('#C9B178');
    doc.setLineWidth(1.5);
    doc.line(40, 75, 555, 75); // line under title

    doc.setFontSize(12);
    doc.setFont('Poppins', 'normal');
    doc.text(`${getTranslation('date_redaction')}: ${dateRedaction}`, 40, 95);

    // Fonction pour extraire toutes les données du formulaire
    const formData = new FormData(document.getElementById('testamentForm'));
    let y = 115;

    // Fonction utilitaire pour ajouter sections dans PDF avec mise en forme
    function addSection(title) {
        doc.setFont('Playfair Display', 'bold');
        doc.setFontSize(16);
        doc.setTextColor('#2D4C68');
        doc.text(title, 40, y);
        y += 20;
        doc.setDrawColor('#C9B178');
        doc.setLineWidth(0.4);
        doc.line(40, y, 555, y);
        y += 15;
        doc.setFont('Poppins', 'normal');
        doc.setFontSize(11);
        doc.setTextColor('#1E1E24');
    }

    // Fonction pour écrire une paire clé/valeur
    function addKeyValue(key, value) {
        const lines = doc.splitTextToSize(`${key}: ${value}`, 515);
        if (y + (lines.length * 12) > 780) { // New page check
            doc.addPage();
            y = 40;
        }
        doc.text(lines, 40, y);
        y += lines.length * 12 + 5;
    }

    // Ajouter les sections et leurs données
    addSection(getTranslation('informations_personnelles'));
    addKeyValue('Nom complet', formData.get('nom') || '');
    addKeyValue('Date de naissance', formData.get('dateNaissance') || '');
    addKeyValue('Lieu de naissance', formData.get('lieuNaissance') || '');
    addKeyValue('Nationalité', formData.get('nationalite') || '');
    addKeyValue('Adresse', formData.get('adresse') || '');
    addKeyValue('Sexe', formData.get('sexe') || '');
    addKeyValue('Situation familiale', formData.get('situationFamiliale') || '');

    addSection(getTranslation('composition_familiale'));
    // Parents
    for (let [key, value] of formData.entries()) {
        if (key.startsWith('parents')) {
            addKeyValue(key, value);
        }
    }
    // Conjoint, enfants, fratrie same way
    for(let prefix of ['conjoint', 'enfants', 'fratrie', 'autresFamille']) {
        for (let [key, value] of formData.entries()) {
            if (key.startsWith(prefix)) {
                addKeyValue(key, value);
            }
        }
    }

    addSection(getTranslation('evaluation_patrimoine'));
    addKeyValue('Biens immobiliers', formData.get('immobilier') + ' €');
    addKeyValue('Comptes bancaires', formData.get('comptes') + ' €');
    addKeyValue('Véhicules', formData.get('vehicules') + ' €');
    addKeyValue('Bijoux', formData.get('bijoux') + ' €');
    addKeyValue('Investissements', formData.get('investissements') + ' €');
    addKeyValue('Autres biens', formData.get('autresBiens') + ' €');
    addKeyValue('Patrimoine total', formData.get('totalPatrimoine') + ' €');

    addSection(getTranslation('dettes_creances'));
    for (let [key, value] of formData.entries()) {
        if (key.startsWith('creances') || key.startsWith('dettes') || key.startsWith('sadaqa')) {
            addKeyValue(key, value);
        }
    }

    addSection(getTranslation('repartition_heritage'));
    const heritageContainer = document.getElementById('heritageGrid');
    if (heritageContainer.children.length > 0) {
        Array.from(heritageContainer.children).forEach(child => {
            const txt = child.textContent.trim();
            addKeyValue('', txt);
        });
    }

    addSection(getTranslation('patrimoine_numerique'));
    for(let prefix of ['reseaux-sociaux', 'emails', 'comptes-online', 'cloud', 'appareils']) {
        for (let [key, value] of formData.entries()) {
            if (key.startsWith(prefix)) {
                addKeyValue(key, value);
            }
        }
    }

    addSection(getTranslation('dernieres_volontes'));
    addKeyValue('Dernières volontés', formData.get('dernieresVolontes') || '');
    addKeyValue('Exécuteur', formData.get('executeurTestamentaire') || '');
    addKeyValue('Date rédaction', formData.get('dateRedaction') || '');
    addKeyValue('Lieu rédaction', formData.get('lieuRedaction') || '');

    doc.save('Testament-Islamique.pdf');
}

// Envoyer le PDF par e-mail avec EmailJS (setup requis)
async function envoyerParEmail() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        await genererPDF(); // générer le PDF en mémoire (à améliorer si besoin)

        // TODO: obtenir le PDF en base64 ou blob pour attacher à emailjs
        alert('Fonction d\'envoi par email à configurer avec EmailJS ou backend.');

    } catch (error) {
        alert(getTranslation('erreur') + ': ' + error.message);
    }
}

// Sauvegarde brouillon (exemple simple dans localStorage)
function sauvegarderBrouillon() {
    const form = document.getElementById('testamentForm');
    const formData = new FormData(form);
    const dataObject = {};
    for (let [key, value] of formData.entries()) {
        dataObject[key] = value;
    }
    localStorage.setItem('brouillonTestament', JSON.stringify(dataObject));
    alert(getTranslation('sauvegarde'));
}

// Charger brouillon au démarrage (optionnel)
function chargerBrouillon() {
    const brouillon = localStorage.getItem('brouillonTestament');
    if (brouillon) {
        const data = JSON.parse(brouillon);
        for(const [key, value] of Object.entries(data)) {
            const field = document.querySelector(`[name="${key}"]`);
            if (field) {
                field.value = value;
            }
        }
    }
}
document.addEventListener('DOMContentLoaded', chargerBrouillon);

// Footer HTML (à placer à la fin du body dans PARTIE 1)
</script>

<footer class="footer">
    <div class="footer-content" role="contentinfo">
        <div class="footer-section">
            <h3 data-fr="Contact" data-ar="اتصال">Contact</h3>
            <p>Al Wassiya</p>
            <p>email: contact@alwassiya.com</p>
            <p>Tel: +33 1 23 45 67 89</p>
        </div>
        <div class="footer-section">
            <h3 data-fr="Informations légales" data-ar="معلومات قانونية">Informations légales</h3>
            <a href="#" aria-label="Mentions légales" data-fr="Mentions légales" data-ar="الإشعارات القانونية">Mentions légales</a>
            <a href="#" aria-label="Politique de confidentialité" data-fr="Politique de confidentialité" data-ar="سياسة الخصوصية">Politique de confidentialité</a>
        </div>
        <div class="footer-section">
            <h3 data-fr="Suivez-nous" data-ar="تابعنا">Suivez-nous</h3>
            <a href="#" aria-label="Facebook">Facebook</a>
            <a href="#" aria-label="Twitter">Twitter</a>
            <a href="#" aria-label="Instagram">Instagram</a>
        </div>
    </div>
    <div class="footer-bottom" role="contentinfo">
        &copy; 2025 Al Wassiya. Tous droits réservés.
    </div>
</footer>
